<!DOCTYPE html>
<html lang="es">
<head>
	<!--Evitar recarga de cach√© por si hay actualizaciones-->
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
	<meta http-equiv="Pragma" content="no-cache" />
	<meta http-equiv="Expires" content="0" />
	<!----->
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<link type="text/css" rel="stylesheet" href='css\component-chosen.css'>
	<link type="text/css" rel="stylesheet" href='css\component-chosen.min.css'>
	<link type="text/css" rel="stylesheet" href='css\bootstrap.min.css'>
	<title>Mapa Congregaci√≥n Sur Villa Nueva</title>
	<link rel="canonical" href="https://getbootstrap.com/docs/5.2/examples/dashboard/">
	<link rel="canonical" href="https://getbootstrap.com/docs/5.2/examples/modals/">
	<link href="modals.css" rel="stylesheet">
	<script src="geojson/casas.geojson" type="text/javascript"></script>
	<script src="geojson/territorios.geojson" type="text/javascript"></script>
	<script src="geojson/perimetro.geojson" type="text/javascript"></script>
	<script src="geojson/PerimetroLineal.geojson" type="text/javascript"></script>
	<script src="geojson/encuentros.json" type="text/javascript"></script>
	<script src="geojson/manzanas.geojson" type="text/javascript"></script>
	<script src="permisos.txt" type="text/javascript"></script>
	<!--Programa de salidas en formato JSON-->
	<script src="salidas.json"></script>
	<!-- JS -->
	<script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
	integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
	crossorigin=""></script>
	<!-- Turf.js para c√°lculos geom√©tricos -->
	<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
	<!-- CSS -->
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
	integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
	crossorigin=""/>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css"/>
	<!-- Repositorios en l√≠nea y locales -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
	<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
	<link rel="stylesheet" href="libs/leaflet-measure-path.css"/>
	<link rel="stylesheet" href="./css/leaflet-sidebar.css"/>
	<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
	<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
	<script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
	<script src="libs/editable.js" ></script>
	<script src="libs/measure.js"></script>
	<script src="./js/leaflet-sidebar.js"></script>
	<script src="https://kit.fontawesome.com/68fa6cffda.js" crossorigin="anonymous"></script>
	<script src="js/jquery-3.4.1.min.js" ></script>
	<script src="js/chosen.jquery.js" type="text/javascript"></script>
	<!-- Leaflet Routing Machine -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
	<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
	<!--- para acceder a Google-Drive-->
	<script src="permisogoogledrive.txt" type="text/javascript"></script>
	<!-- A√±ado un pluging de minimapa -->
	<!--<script src="https://cdn.jsdelivr.net/gh/maneoverland/leaflet.WorldMiniMap@1.0.0/dist/Control.WorldMiniMap.js" integrity="sha512-PFw8St3qenU1/dmwCfiYYN/bRcqY1p3+sBATR+rZ6622eyXOk/8izVtlmm/k8qW7KbRIJsku838WCV5LMs6FCg==" crossorigin=""></script>-->
	
	<!--Clases para personalizar algunos elementos-->
	<meta name="theme-color" content="#712cf9"></meta>
	<style>
        body {
            padding: 0;
            margin: 0;
        }
        html, body, #map {
            height: 100%;
            font: 10pt "Helvetica Neue", Arial, Helvetica, sans-serif;
        }
        .lorem {
            font-style: italic;
            color: #AAA;
        }
		.popups.leaflet-popup-tip,
		.popups.leaflet-popup-content-wrapper {
			background-color: #3182bd;
		}
		.popups.leaflet-popup-tip,
		.popups.leaflet-popup-content-wrapper {
			background-color: #3182bd;
		}
		a{
			text-align: center;
			display: inline;
			width: 100%;
		}
		/*Configuraci√≥n del √°rea del mapa*/
		#mapa {
			width:100%;
			height:87%;
			border: 0.5cm solid red;
			padding: 0px;
			margin: 0px;
		}
		.botonnorte {
			position: absolute;
			top: 10px;
			right: 10px;
			background: red;
			border: none;
			cursor: pointer;
			padding: 0;
			z-index:1030;
		}
		.botonnorte img {
			width: 40px;
			height: 40px;
			border-radius: 10px;
			box-shadow: 0 2px 5px rgba(0,0,0,0.3);
			transition: transform 0.2s;
		}
		.botonnorte img:hover {
			transform: scale(1.5);
		}
		
		.flechaizquierdaroja {
			position: absolute;
			top: 48%;
			left: 3%;
			background: red;
			border: none;
			cursor: pointer;
			padding: 0;
			z-index:1030;
		}
		.flechaizquierdaroja img {
			width: 40px;
			height: 40px;
			border-radius: 10px;
			box-shadow: 0 2px 5px rgba(0,0,0,0.3);
			transition: transform 0.2s;
		}
		
		.botoncentrado {
			position: absolute;
			top: 130px;
			right: 80px;
			background: none;
			border: none;
			cursor: pointer;
			padding: 0;
			z-index:1030;
		}
		.botoncentrado img {
			width: 35px;
			height: 35px;
			border-radius: 10px;
			box-shadow: 0 2px 5px rgba(0,0,0,0.3);
			transition: transform 0.2s;
		}
		.botoncentrado img:hover {
			transform: scale(1.5);
		}
		
		#distancia {
			position: absolute;
			top: 1px;
			left: 50%;
			transform: translateX(-50%);
			width: 80%;
			max-width: 580px;
			min-width: 280px;
			padding: 10px 14px;
			border-radius: 8px;
			text-align: center;
			font-size: 15px;
			font-weight: bold;
			background: #d4edda;
			color: #155724;
			box-shadow: 0 0 6px rgba(0,0,0,0.3);
			z-index: 999;
			display: none;
		}
		#distancia.visible {
			display: block;
		}

		
		/*Modal Flash*/
		.modalflash {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			width: 95vw;
			max-width: 700px;
			max-height: 90vh;
			background-color: yellow;
			border: 2px solid black;
			border-radius: 10px;
			display: flex;
			flex-direction: column;
			/*overflow: hidden;*/
			overflow-y: auto;
			z-index: 99999;   /* MUY IMPORTANTE */
		}
		.modalflash-cabecera {
			background: red;
			color: white;
			padding: 12px;
			font-weight: bold;
			text-align: center;
			flex-shrink: 0;
		}
		.modalflash-cuerpo {
			padding: 15px;
			flex: 1;                /* OCUPA TODA LA ALTURA RESTANTE */
			overflow-y: auto;       /* SCROLL SI SE LLENA */
		}
		.modalflash-botones {
			display: flex;              /* CLAVE */
			justify-content: center;    /* centra horizontal */
			align-items: center;
			gap: 20px;                  /* espacio entre botones */
			margin-top: 15px;
		}

		/* estilos de botones */
		.modalflash-botones button {
			height: 30px;
			width: 90px;
			color: white;
			border-radius: 4px;
			cursor: pointer;
		}

		#btn-indicaciones-modal-flash {
			background-color: blue;
			color:white;
			border: 1px solid white;
			height:30px;
			width:90px;
			display: flex;
			align-items: center;      /* centra vertical */
			justify-content: center;  /* centra horizontal */
		}

		#btn-cerrar-modal-flash {
			background-color: red;
			color:white;
			border: 1px solid white;
			height:30px;
			width:90px;
			display: flex;
			align-items: center;      /* centra vertical */
			justify-content: center;  /* centra horizontal */
		}
		.modalflash-contador {
			display: flex;
			justify-content: center;   /* centra horizontal */
			align-items: center;
			margin-top: 10px;
			text-align: center;
		}

		@media (max-width: 600px) {
			.modalflash {
				width: 83vw;
				height: 75vh;
				/*overflow-y: auto;*/
			}
			.fila {
				flex-wrap: nowrap;
			}
			.novedad{left:8px;right:8px;max-width:calc(100% - 16px)}
		}
		
		/*Bot√≥n para recargar la p√°gina*/
		.boton-recargar {
			border: 3px solid #374151; background: linear-gradient(180deg, #1f2937, #111827);
			color: #22d3ee; border-radius: 14px; cursor: pointer; font-weight: 600; box-shadow: 0 6px 18px rgba(0,0,0,.35);
			transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease; position:fixed;
			bottom:10px;right:30px; width: 200px; height: 50px;
		}
		.boton-recargar:hover {
			border-color: #22d3ee; box-shadow: 0 8px 24px rgba(34,211,238,.25);
		}
		.boton-recargar:active {
			transform: translateY(1px);
		}
		
		/*Bot√≥n para informar lo que se predic√≥*/
		.boton-predicado {
			border: 3px solid #374151; background: linear-gradient(180deg, #1f2937, #111827);
			color: #22d3ee; border-radius: 14px; cursor: pointer; font-weight: 600; box-shadow: 0 6px 18px rgba(0,0,0,.35);
			transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease; position:fixed;
			bottom:130px;right:30px; width: 200px; height: 50px;
		}
		.boton-predicado:hover {
			border-color: #22d3ee; box-shadow: 0 8px 24px rgba(34,211,238,.25);
		}
		.boton-predicado:active {
			transform: translateY(1px);
		}
		
		/*Bot√≥n para informar un nuevo NO VISITAR*/
		.boton-novisitar {
			border: 3px solid #374151; background: linear-gradient(180deg, #1f2937, #111827);
			color: #22d3ee; border-radius: 14px; cursor: pointer; font-weight: 600; box-shadow: 0 6px 18px rgba(0,0,0,.35);
			transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease; position:fixed;
			bottom:70px;right:30px; width: 200px; height: 50px;
		}
		.boton-novisitar:hover {
			border-color: #22d3ee; box-shadow: 0 8px 24px rgba(34,211,238,.25);
		}
		.boton-novisitar:active {
			transform: translateY(1px);
		}
		
		/*Bloque para el Calendario*/
		.controles {
			position: absolute; top: 12px; right: 12px; display: flex; flex-direction: column; gap: 10px; z-index: 500;
		}
		.boton-calendario {
			border: 3px solid #374151; background: linear-gradient(180deg, #1f2937, #111827);
			color: #22d3ee; border-radius: 14px; cursor: pointer; font-weight: 600; box-shadow: 0 6px 18px rgba(0,0,0,.35);
			transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease; position:fixed;
			bottom:190px;right:30px; width: 200px; height: 50px;
		}
		.boton-calendario:hover {
			border-color: #22d3ee; box-shadow: 0 8px 24px rgba(34,211,238,.25);
		}
		.boton-calendario:active {
			transform: translateY(1px);
		}
		.pill {
			font-size: 12px; padding: 6px 10px; background: #0b1220; border: 1px solid #374151; border-radius: 999px; color:#9ca3af;
		}
		.pill strong {
			color: #38bdf8;
		}
		
		/*Fondo Oscurecido*/
		/*.modal-calendario {*/
			/*position: fixed; inset: 0; background: rgba(3,7,18,.6); backdrop-filter: blur(2px); display: none; z-index: 1000; place-items: center start;*/
		/*}*/
		/*.modal-calendario[aria-hidden="false"] {*/
			/*display: grid;*/
		/*}*/
		
		/* Fondo oscuro con blur */
		.capaoscura {
			position: fixed;
			inset: 0;
			background: rgba(3,7,18,.6);
			backdrop-filter: blur(5px);
			display: none;
			align-items: center;
			justify-content: center;
			top: 10%;
			bottom: 10%;
			overflow-y: auto;
			z-index: 1000;
		}
		.capaoscura.active {
			display: flex;
		}

		/* Contenedor de modales */
		.modales {
			background: #111827ee;
			display: grid;
			gap: 1rem;
			width: 90%;
			max-width: 800px;
			max-height: 350px;
			margin-left: 25px;
		}
		@media (min-width: 700px) {
			.modales {
				grid-template-columns: 1fr 1fr;
			}
		}
		
		/*Formato de los elementos dialog*/
		dialog {
			max-width: 70%;
			max-height: 70%;   /* limita la altura del contenido */
			overflow-y: auto;     /* activa la barra de desplazamiento vertical */
		}

		.modal {
			background: pink;
			padding: 1rem;
			border-radius: 12px;
			box-shadow: 0 4px 12px rgba(0,0,0,0.3);
			position: relative;
			min-width: 250px;
		}

		.modal h2 {
			margin-top: 0;
		}
  
		.modalcal {
			justify-self: start; margin-left: 20%; margin-top:20%; background: #111827ee; border: 1px solid #374151; border-radius: 18px; box-shadow: 0 30px 80px rgba(0,0,0,.5); overflow: hidden; width:25%;/*width: min(92vw, 420px);*/
			/*justify-self: start; margin-left: 20%; background: #111827ee; border: 1px solid #374151; border-radius: 18px; box-shadow: 0 30px 80px rgba(0,0,0,.5); overflow: hidden; width:30%; height:75%;/*width: min(92vw, 420px);*/*/
		}
		.modalcal-cabecera {
			display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid #374151;
		}
		.modalcal-titulo {
			font-weight: 700; letter-spacing: .2px;color:#22d3ee;
		}
		.modalcal-cerrar {
			background: transparent; color: #9ca3af; border: none; font-size: 18px; cursor: pointer; padding: 6px 8px; border-radius: 10px;
		}
		.modalcal-cerrar:hover {
			color: #e5e7eb; background: #0b1220;
		}
		.calendario {
			padding: 12px 16px 18px;
		}
		.calendario-grid {
			display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px;
		}
		.calendario-semana {
			text-align: center; font-size: 12px; color: #9ca3af; padding: 8px 0;
		}
		.calendario-dia {
			text-align: center; padding: 10px 0; border: 1px solid #374151; border-radius: 12px; cursor: pointer; user-select: none; transition: transform .06s ease, border-color .2s ease, background .2s ease;
		}
		.calendario-dia:hover {
			border-color: #22d3ee;
		}
		.calendario-dia:active {
			transform: translateY(1px);
		}
		.calendario-dia[aria-disabled="true"] {
			opacity: .28; cursor: not-allowed;
		}
		.calendario-dia.hoydia {
			outline: 2px solid #38bdf8; outline-offset: 2px;
		}
		.calendario-dia.selected {
			background: linear-gradient(180deg, #0ea5e9, #0891b2); border-color: #06b6d4; color: white;
		}
		.calendario-encabezado {
			display: flex; justify-content: space-between; align-items: center; margin-top: 12px; font-size: 13px; color: #9ca3af;
		}
		.modalsal {
			justify-self: start; margin-left: 40%; margin-top:10%; background: #111827ee; border: 1px solid #374151; border-radius: 18px; box-shadow: 0 30px 80px rgba(0,0,0,.5); overflow: hidden; width: 25%;/*width: min(92vw, 420px);*/
			/*justify-self: start; margin-left: 70%; background: #111827ee; border: 1px solid #374151; border-radius: 18px; box-shadow: 0 30px 80px rgba(0,0,0,.5); overflow: hidden; width: 30%; height:75%;/*width: min(92vw, 420px);*/*/
		}
		.modalsal-cabecera {
			display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid #374151;
		}
		.modalsal-titulo {
			font-weight: 700; letter-spacing: .2px;color:#22d3ee;
		}
		.modalsal-cerrar {
			background: transparent; color: #9ca3af; border: none; font-size: 18px; cursor: pointer; padding: 6px 8px; border-radius: 10px;
		}
		.modalsal-cerrar:hover {
			color: #e5e7eb; background: #0b1220;
		}
		.infosalidas {
			height:300px; padding: 12px 16px 18px;
			overflow: auto;
		}
		
		/*Cuadro animado*/
		.colorful-div {
			width: 300px;
			height: 10%;
			border-radius: 20px;
			background: linear-gradient(270deg, #ff5f6d, #ffc371, #24c6dc, #514a9d);
			background-size: 800% 800%;
			animation: gradientShift 10s ease infinite;
			display: flex;
			justify-content: center;
			align-items: center;
			color: white;
			font-size: 1rem;
			box-shadow: 0 10px 25px rgba(0,0,0,0.3);
			text-align: center;
		}

		@keyframes gradientShift {
			0% { background-position: 0% 50%; }
			50% { background-position: 100% 50%; }
			100% { background-position: 0% 50%; }
		}
		/*Iconos manzanas*/
		.circle-label {
			font-size: 14px;
			font-weight: bold;
			color: white;
			text-align: center;
			text-shadow: 0 0 2px black;
		}
		
		/*Boton para desplegar detalles de rutas sugeridas*/
		#BotonDetallesRuta {
			position: fixed;
			top: 28%;
			right: 3%;
			z-index: 1050;
			background: #fff;
			color: white;
			border: 1px solid #777;
			border-radius: 6px;
			cursor: pointer;
			font-weight: bold;
			box-shadow: 0 2px 4px rgba(0,0,0,.3);
			animation: pulsobotonlimpiar 2s infinite ease-in-out;
		}
		@keyframes pulsobotonlimpiar {
			0% {
				background-color: #001a33;
				transform: translateX(-50%) scale(1);
				box-shadow: 0 0 10px rgba(0,255,255,0.5);
			}
			50% {
				background-color: #004c99; /* azul m√°s claro */
				transform: translateX(-50%) scale(1.12);
				box-shadow: 0 0 26px rgba(0,255,255,1);
			}
			100% {
				background-color: #001a33;
				transform: translateX(-50%) scale(1);
				box-shadow: 0 0 10px rgba(0,255,255,0.5);
			}
		}
		
		#PanelRutas {
			position:fixed;
			top: 35%;
			right: 0;
			z-index:1050;
			display:none;           /* ‚Üê CLAVE */
			background:white;
			border-radius:6px;
			box-shadow:0 2px 6px rgba(0,0,0,.35);
		}
		
		/*Bloque para resaltar lo NUEVO*/
		/* Clase resaltado con animaci√≥n */
		.resaltarlonovedoso {
			animation: palpitar 1s infinite ease-in-out, cambiarColor 3s infinite ease-in-out;/*2s infinite alternate;*/
		}
		/* Palpitar (latido) */
		@keyframes palpitar {
			0%   { transform: scaleX(1); }
			50%  { transform: scaleX(1.5); }
			100% { transform: scaleX(1); }
		}
		/* Cambiar color entre dos tonos */
		@keyframes cambiarColor {
			0%   { background-color: #ff4d4d;}  /* rojo */
			33%  { background-color: #4dff4d;}  /* verde */
			66%  { background-color: #4d4dff;}  /* azul */
			100% { background-color: #ff4d4d;} 
		}
		
		/* el bot√≥n al que apunta la flecha */
		.area-ejemplo{display:flex;gap:20px;align-items:center}
		button{padding:10px 16px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer}
		.primario{background:green;color:#fff;border:none}

		/* capa y modal (tooltip grande) */
		.capa{position:fixed;inset:0;background:transparent;display:none;z-index:1500}
		.capa.active{display:block}

		/* gu√≠a/tooltip */
		.novedad{
		position:absolute;max-width:220px;padding:20px 16px;border-radius:10px;background:#a1d99b;box-shadow:0 8px 22px rgba(0,0,0,0.18);z-index:1000;cursor:pointer;transform-origin:center top;transition:transform .14s ease,opacity .12s ease;opacity:0;transform:translateY(-6px);color:green;
		}
		.novedad.show{opacity:1;transform:translateY(0)}

		/* flecha: apuntando hacia abajo (modal encima del bot√≥n) */
		.novedad::after{
		content:"";position:absolute;width:14px;height:14px;background:red;transform:rotate(45deg);left:50%;transform-origin:center;box-shadow:0 4px 8px rgba(0,0,0,0.08);
		/* se colocar√° con JS ajustando --arrow-x */
		top:100%;margin-left:calc(var(--arrow-x, -7px));
		}
		.novedad.oculto::after {
			content: none;
		}

		/* cuando el modal est√° debajo del bot√≥n, usamos la clase bottom y movemos la flecha arriba */
		.novedad.bottom::after{top:auto;bottom:100%;}

		/* texto dentro de la gu√≠a */
		.novedad h4{margin:0 0 6px 0;font-size:15px;text-align: center}
		.novedad p{margin:0;font-size:13px;color:#444}

		/* estilo peque√±o para indicar acci√≥n */
		.hint{margin-top:10px;font-size:12px;color:#666}

		@media (max-width:420px){
		.novedad{left:8px;right:8px;max-width:calc(100% - 16px)}
		}
		/* üîß Ajuste del contenedor que envuelve los controles (Leaflet lo crea autom√°ticamente) */
		.leaflet-top.leaflet-right {
			top: 60px !important;
			right: 10px !important;
		}
		/* Opcional: eliminar m√°rgenes entre controles */
		.leaflet-control {
			margin: 0 !important;
		}
		
		/*Configuraci√≥n adicional de la Barra Lateral para insertar Iconos Locales*/
		.sidebar-tabs1 > ul > li > a img {
			width: 32px !important;    /* tama√±o ideal */
			height: 32px !important;
			object-fit: contain !important;
			display: block !important;
			padding: 0 !important;
			margin: 0 auto !important;
		}
		#barralateral img {
			width: 40px;
			height: auto;
			vertical-align: middle;
			margin-right: 2px;
		}
		
		/*Configuraci√≥n de la Barra Lateral*/
		#barralateral {
			position: absolute;
			z-index: 550;
			max-width: 80%;
		}
		
		/*Formatea un elemento para que sus p√°rrafos se alinien a la izquierda, el siguiente a la derecha y los pr√≥ximos al centro*/
		.contenedoralineado {
			display: flex;                 /* Activa Flexbox */
			justify-content: space-between;/* Separa los elementos */
			align-items: center;           /* Alinea verticalmente al centro */
			border: 1px solid #ccc;        /* Solo para visualizar el contenedor */
			padding: 1px;
			height: 10%;
		}
		.contenedoralineado p {
			margin: 0; /* Elimina m√°rgenes por defecto */
		}

		/*Giro y animaci√≥n flecha activar el GPS*/
		.img-color-animada {
			width: 20px;
			display: inline-block;
			transform: rotate(-90deg);       /* Giro inicial de 90¬∞ izquierda */
			animation: cambioColor 2s infinite alternate;
		}
		
		@keyframes cambioColor {
			from {
				filter: hue-rotate(0deg);
			}
			to {
				filter: hue-rotate(180deg);
			}
		}
    </style>
	<!--Icono para la pesta√±a del navegador-->
	<link rel="shortcut icon" href="./images/Tetragramaton.ico" type="image/x-icon"/>
</head>
<header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
	<a style="font-size:15px; color:#22d3ee; display=inline-block"><strong>MAPA DE TERRITORIOS DE LA CONGREGACION SUR VILLA NUEVA (N¬∫ 6379)</strong></a>
	<div id="ubicacion">
		<!--<div id="activargps" class="colorful-div">¬øNecesit√°s indicaciones para llegar? Activ√° aqu√≠...</div>-->
		<div id="activargps" class="colorful-div" onclick="activar_seguimiento()">
			¬øNecesit√°s indicaciones para llegar? Activ√°...
			<img src="images/flecha_izquierda.png" class="img-color-animada" alt="">
		</div>
		<div id="ubicacion_texto" style="font-size:10px; text-align:right; background-color:grey; color:blue"><strong>Activar/Desactivar mi ubicaci√≥n</strong><a id="ubicacion_estado" href="javascript:activar_seguimiento()"><img id="gps" src="images/slide_off.jpg" width="50" height="30"></img></a></div>
	</div>
	<img src="images/Tetragramaton.jpg" width="60" height="60"></img>
</header>
<header>
	<div id="texto_ayuda" class="contenedoralineado">
		<!--<p style="font-size:12px; color:blue;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src="images/flecha_izquierda.png" width="20" height="20"></img>Para Ayuda, toc√° ‚ò∞ </p>-->
		<p id="vermiubicacion"><a style="font-size:12px; color:blue;" href="javascript:CentrarMiUbicacion()"><img src="images/posicion.png" width="20" height="20"></img>Ver mi ubicaci√≥n</a></p>
	</div>
</header>
<body>
	<div id="mapa" style="width:100%;height:90%;">
		<div id="barralateral" class="sidebar collapsed">
			<div class="sidebar-tabs">
				<ul role="tablist">
					<li><a href="#home" role="tab"><i class="fa fa-bars" style="color: #3f08f2;"></i></a></li>
					<li><a href="#mapita" role="tab"><img src="images/Mapear.png"></img></a></li>
					<li><a id="casas_hnos" href="#familias" role="tab"><img src="images/Home.jpg"></img></a></li>
					<li><a href="#configuracion" role="tab"><img src="images/Herramientas.png"></img></a></li>
					<li><a href="#informes" role="tab"><img src="images/Informacion.png"></img></a></li>
					<li><a href="#ayuda" role="tab"><img src="images/Ayuda.jpg"></img></a></li>
					<li><a href="#logueo" role="tab"><img src="images/Usuario.png"></img></a></li>
				</ul>
			</div>
			<div class="sidebar-content">
				<div class="sidebar-pane" id="home">
					<h1 class="sidebar-header">
						BARRA DE OPCIONES
						<span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
					</h1>
					<br></br>
					<p style="color:blue"><strong>¬øC√≥mo funciona cada herramienta de esta barra?</strong></p>
					<p class="lorem"><img src="images/Mapear.png"></img>Te ayudar√° a encontrar un territorio</p>
					<p class="lorem"><img src="images/Home.jpg"></img>Te ayudar√° a encontrar la casa de un publicador</br>(En caso que est√©s registrado como usuario)</p>
					<p class="lorem"><img src="images/Herramientas.png"></img>Te permitir√° acceder a las herramientas de configuraci√≥n disponibles</p>
					<p class="lorem"><img src="images/Informacion.png"></img>Consult√° las salidas de cada d√≠a del mes, Inform√° lo que se predic√≥ o si encontraste un nuevo NO VISITAR</p>
					<p class="lorem"><img src="images/Ayuda.jpg"></img>Te dar√° detalles sobre c√≥mo usar cada herramienta</p>
					<p class="lorem"><img src="images/Usuario.png"></img>Secci√≥n para usuarios registrados</p>
					<p class="lorem"><i class="fa-solid fa-circle-exclamation" style="color: #3f08f2;"></i>¬øEncontraste alg√∫n problema o ten√©s alguna sugerencia para mejorar este sitio?</p>
					<p class="lorem">Por favor, comunicate con alguno de los ancianos.-</p>
				</div>
				<div class="sidebar-pane" id="mapita">
					<h1 class="sidebar-header">Buscar el territorio...<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
					<br></br>
					<p id="titulobuscarterritorio" class="lorem">Escrib√≠ o seleccion√° el territorio...</p>
					<select id="selector_territorios" name="CasasHnos" data-placeholder="- Seleccion√° o escrib√≠ el territorio que dese√°s ubicar -"
						class="form-control chosenCasas" value="<%= typeof Casas != 'undefined' ? Casas : '' %>" onchange="TerritorioAbuscar(value,'territorio')">
						<option value=""></option>
					</select>
					<br></br>
					<p id="parrafoterritorio" style="color:blue">Escrib√≠ el n√∫mero del territorio que dese√°s ubicar o bien elegilo desde el men√∫ desplegable y te centrar√° el mapa sobre √©l, mostr√°ndote su informaci√≥n, tal como nombre de los barrios que abarca y lista de casas "NO VISITAR".</p>
				</div>
				<div class="sidebar-pane" id="familias">				
					<h1 class="sidebar-header">Buscar la casa...<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
					<br></br>
					<p id="titulobuscarflia" class="lorem">Escrib√≠ o seleccion√° una familia...</p>
					<select id="selector_casas" name="CasasHnos" data-placeholder="- Seleccion√° o escrib√≠ la familia o hermano que dese√°s ubicar -"
						class="form-control chosenCasas" value="<%= typeof Casas != 'undefined' ? Casas : '' %>" onchange="CasaAbuscar(value)">
						<option value=""></option>
					</select>
					<br></br>
					<p id="parrafofamilia" style="color:blue">Escrib√≠ alg√∫n dato que conozc√°s del publicador o familia que dese√°s ubicar (nombre y/o apellido) o bien elegilo desde el men√∫ desplegable y te centrar√° el mapa sobre su casa, mostr√°ndote informaci√≥n, tal como nombres de los integrantes de la familia, privilegios de servicio, direcci√≥n postal, tel√©fono y foto del frente de la casa para que pod√°s identificarla al llegar.</p>
					<br></br>
					<p>
						<input id="mostrarflias" type="submit" style="background-color:#acf89f" value="Ver todas las familias" onclick="VerTodasFlias();"></input>
						<input id="ocultarflias" type="submit" style="background-color:#f48d8d" value="Quitar familias del mapa" onclick="QuitarTodasFlias();"></input>
					</p>
				</div>
				<div class="sidebar-pane" id="configuracion">
					<h1 class="sidebar-header">Secci√≥n de configuraci√≥n<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
					<br></br>
					<p id="alternarcapas"><a href="#" onclick="AlternarCapas(); return false;" style="color:blue;"><i class="fa-solid fa-map" style="color: #3f08f2;"></i>  Cambiar vista del mapa de fondo.</a> (Si est√°s viendo el mapa callejero, pasar√°s a ver el satelital y a la inversa).</p>
					<br></br>
					<p id="miubicacion"><a href="#" onclick="CentrarMiUbicacion(); return false;" style="color:blue;"><i class="fa-solid fa-crosshairs" style="color: #3f08f2;"></i>  Mi ubicaci√≥n</a> (En caso que teng√°s el GPS activado, centrar√° el mapa sobre tu ubicaci√≥n actual).</p>
					<br></br>
					<p id="volveralterritorio"><a href="#" onclick="CentrarEnTerritorio(); return false;" style="color:blue;"><i class="fa-solid fa-earth-americas"></i>  Volver al territorio</a> (Centrar el mapa en el territorio de la congregaci√≥n).</p>
					<br></br>
					<p id="volveraempezar"><a href="#" onclick="location.reload(); return false;" style="color:blue;"><i class="fa-solid fa-rotate"></i>  Volver a empezar</a> (Limpiar el mapa para volver a trabajar en √©l).</p>
					<br></br>
					<p id="restablecernomostrar"><a href="#" onclick="RestablecerNoMostrar(); return false;" style="color:blue;"><i class="fa-solid fa-message" style="color: #3f08f2;"></i>  Volver a mostrar mensajes informativos.</a> (Restablecer los mensajes informativos que puedas haber cancelado).</p>
					<br></br>
				</div>
				<div class="sidebar-pane" id="informes">
					<h1 class="sidebar-header">Secci√≥n de informes<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
					<br></br>
					<p id="calendariosalidas"><a href="#" onclick="AbrirModalCalendario('modal1'); return false;" style="color:blue;"><i class="fa-solid fa-calendar-days" style="color: #3f08f2;"></i>  Mostrar el calendario.</a> (Consult√° las salidas para este mes).</p>
					<br></br>
					<p><a href="#" onclick="ReportarPredicado(); return false;" style="color:blue;"><i class="fa-solid fa-pen-to-square" style="color: #3f08f2;"></i>  Informar lo que se predic√≥.</a> (Si dirigiste una salida, por favor, inform√° lo que se abarc√≥).</p>
					<br></br>
					<p><a href="#" onclick="ReportarNoVisitar(); return false;" style="color:blue;"><i class="fa-solid fa-pen-to-square" style="color: #3f08f2;"></i>  Alguien pidi√≥ que no lo volvamos a visitar.</a> (Avis√° para que se agregue a la lista de los NO VISITAR).</p>
				</div>
				<div class="sidebar-pane" id="ayuda">
					<h1 class="sidebar-header">Secci√≥n de ayuda<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
					<br></br>
					<p class="lorem"><img src="images/Mapear.png"></img>Te ayudar√° a encontrar un territorio</p>
					<br></br>
					<p>Escribe el n√∫mero del territorio que dese√°s ubicar o bien elegilo desde el men√∫ desplegable y te centrar√° el mapa sobre √©l, mostr√°ndote su informaci√≥n, tal como nombre de los barrios que abarca y lista de casas "NO VISITAR".</p>
					<br></br>
					<div id="ayuda_usuario">
						<p class="lorem"><img src="images/Home.jpg"></img>Te ayudar√° a encontrar la casa de un publicador</br>(En caso que est√©s registrado como usuario o seas el viajante)</p>
						<br></br>
						<p>Escribe alg√∫n dato que conozcas del publicador o familia que dese√°s ubicar (nombre y/o apellido) o bien elegilo desde el men√∫ desplegable y te centrar√° el mapa sobre su casa, mostr√°ndote informaci√≥n, tal como nombres de los integrantes de la familia, privilegios de servicio, direcci√≥n postal, tel√©fono y foto del frente de la casa para que puedan identificarla al llegar.</p>
						<br></br>
					</div>
					<p class="lorem"><img src="images/Herramientas.png"></img>Te permitir√° acceder a las herramientas de configuraci√≥n disponibles</p>
					<br></br>
					<p>Podr√°s cambiar el mapa de fondo, alternando entre el de s√≥lo calles y el satelital (con casas). Recargar la aplicaci√≥n (ideal para volver a empezar). Tambi√©n podr√°s pedir que se vuelvan a mostrar los mensajes informativos si que los cancelaste anteriormente.</p>
					<br></br>
					<p class="lorem"><img src="images/Informacion.png"></img>Consult√° las salidas de cada d√≠a del mes, Inform√° lo que se predic√≥ o si encontraste un nuevo NO VISITAR</p>
					<br></br>
					<p class="lorem"><img src="images/Usuario.png"></img>Secci√≥n para usuarios registrados</p>
					<br></br>
					<br></br>
					<br></br>
					<br></br>
					<br></br>
					<p class="lorem"><i class="fa-solid fa-circle-exclamation" style="color: #3f08f2;"></i>¬øEncontraste alg√∫n problema o ten√©s alguna sugerencia para mejorar este sitio?</p>
					<p class="lorem">Por favor, comunicate con alguno de los ancianos.-</p>
				</div>
				<div class="sidebar-pane" id="logueo">
					<div id="log_no">
						<h1 class="sidebar-header">Secci√≥n de logueo<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
						<br></br>
						<p class="lorem">Usuario:</p>
						<input type="text" id="username" name="username" value="">
						<p class="lorem">Contrase√±a:</p>
						<input type="password" id="password" name="password" value="">
						<input type="submit" value="Mostrar/Ocultar" onclick="Contrasenia();">
						<br><br>
						<input type="submit" style="background-color:#acf89f" value="Ingresar" onclick="Loguearse();">
					</div>
					<div id="log_si">
						<br></br>
						<input type="submit" style="background-color:#f48d8d" value="Cerrar sesi√≥n" onclick="CerrarSesion();"></input>
					</div>
				</div>
			</div>
		</div>
		<div id="distancia" style="transition: opacity 1s;">Buscando ubicaci√≥n...</div>
		<button id="BotonDetallesRuta">Detalles Ruta</button>
		<div id="PanelRutas"></div>
		<button class="botoncentrado" id="botoncentrado" onclick="CentrarMiUbicacion()" title="Centrar en mi ubicaci√≥n real">
			<img src="./images/posicion.png" alt="Centrar en Mi Ubicaci√≥n">
		</button>
		<button class="botonnorte" id="botonnorte">
			<img src="./images/norte.jpg" alt="Norte del Mapa" title="Norte del mapa">
		</button>
		<button class="flechaizquierdaroja" id="flecharoja">
			<img src="./images/flecha_izquierda_roja.png"><img src="./images/flecha_izquierda_roja.png">
		</button>
	</div>
	
	<div class="modalflash" id="MiModalFlash">
		<div class="modalflash-cabecera" id="titulomodalflash">¬°¬°¬° BIENVENIDO AL MAPA WEB DE LA CONGREGACION SUR VILLA NUEVA...!!!</div>
		<p class="modalflash-cuerpo" id="cuerpomodalflash"><img src="./images/presentacion.jpg" style="display: block; margin: auto; height:80px" id="imagenmodalflash"/><br><strong>Si sos un publicador, este mapa en l√≠nea te permitir√°:</strong>
			<br>Ubicar un territorio con la opci√≥n de hacerlo a partir de tu ubicaci√≥n en tiempo real.
			<br>Es decir, si vos se lo autoriz√°s, te trazar√° una ruta con las indicaciones necesarias para llegar...!!!. Te incluir√° una distancia y demora estimadas y hasta te avisar√° con voz cuando est√©s cerca y cuando hay√°s llegado...!!!
			<br>Podr√°s consultar las salidas del mes en curso y si dirigiste alguna salida, podr√°s enviarle los detalles de lo que se abarc√≥ al hermano encargado de los territorios.
			<br>Adem√°s, si alguien pidi√≥ que no lo visitemos m√°s, podr√°s avisar para que se registre.
			<br><br><strong>Por otra parte, si sos el viajante, adem√°s podr√°s:</strong>
			<br>Localizar las casas y los puntos donde puedas tener tus arreglos para almuerzos, pastoreos y actividad.
			<br><br><strong>En la barra lateral podr√°s encontrar secciones con las herramientas disponibles y un apartado de ayuda para orientarte a encontrarlas y saber su funci√≥n.-</strong>
			<br>
			<div style="text-align: center">
				<label id="borrableinicial">
					<input id="nomostrarinicial" type="checkbox" style="width:16px; height:16px;"/>
					No volver a mostrar
				</label>
				<div class="modalflash-botones" id="botonesModalFlash">
					<button id="btn-indicaciones-modal-flash" onclick="IniciarRuteo()">S√≠</button>
					<button id="btn-cerrar-modal-flash">Cerrar</button>
				</div>
			</div>
			<div class="modalflash-contador">
				<span style="font-weight: bold; color:red; text-align: center;">Me cierro en: <span id="contador"> </span> segundos</span>
			</div>
		</p>
	</div>
	
	<!--Modal para reportar lo que se predic√≥ en una salida-->
	<div class="modalflash" id="ModalReportePredicado" style="font-size:15px;">
		<div class="modalflash-cabecera" id="titulomodalpredicado">¬°¬°¬° MUCHAS GRACIAS POR TOMARTE ESTE TIEMPITO...!!!</div>
		<div class="modalflash-cuerpo" id="cuerpomodalpredicado">
			<strong>Estos registros ayudan a predicar a conciencia nuestro territorio</strong>
			<br><br>
			<label>Fecha: <input id="fechapredicado" type="date" style="width:200px;"></label><br>
			<label>Tu nombre: <input id="nombrepredicado" style="width:60%;"></label><br>
			<label>N√∫mero del territorio: <input id="territoriopredicado" style="width:50%;"></label><br>
			<label>¬øSe predic√≥ TODO el territorio?  
				<input type="checkbox" id="todopredicado">SI&nbsp;&nbsp;&nbsp;
				<input type="checkbox" id="algopredicado">NO
			</label>
			<br><br>
			<label id="manzanaspredicadas">Lo que se abarc√≥: <input id="abarcadopredicado" placeholder="Letras de las manzanas predicadas" style="width:60%;"></label>
			<br><br>
			<label id="leyendamanzanaspredicadas">Para identificar las manzanas hac√© el m√°ximo zoom posible sobre el territorio y las ver√°s identificadas con letras.-</label>
			<br><br>
			<pre id="enviandoreporte" style="font-family: 'Arial'; font-weight: bold;"></pre>
			<div style="text-align: center">
				<button id="btn-cerrar-reporte" onclick="CerrarModalReporte()" style="height:35px; width:30%; background-color:red; border-color:white; color:white;">Cerrar</button>
				<button id="btn-enviar-reporte" style="height:35px; width:30%; background-color:green; border-color:white; color:white;">Enviar</button>
			</div>
		</div>
	</div>
	
	<!--Modal para reportar una nueva casa NO VISITAR-->
	<div class="modalflash" id="ModalReporteNoVisitar" style="font-size:15px;">
		<div class="modalflash-cabecera" id="titulomodalnovisitar">¬°¬°¬° MUCHAS GRACIAS POR TOMARTE ESTE TIEMPITO...!!!</div>
		<div class="modalflash-cuerpo" id="cuerpomodalnovisitar"><strong>Informar de una casa donde han pedido que no los volvamos a visitar, ayuda a resguardar la seguridad de nuestros hermanos y tambi√©n puede ser una manera indirecta de dar testimonio.-</strong>
			<br><br>
			<label>Tu nombre: <input id="nombrenovisitar" style="width:70%;"></label><br>
			<label>Fecha: <input id="fechanovisitar" type="date" style="width:200px;"></label><br>
			<label>Direcci√≥n: <input id="direccionnovisitar" style="width:70%;"></label><br>
			<label>N√∫mero del territorio: <input id="territorionovisitar" style="width:20%;"></label><br>
			<label>La persona, ¬øpidi√≥ expresamente que no la visitemos m√°s?  <input type="checkbox" id="expresonovisitar">SI&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp<input type="checkbox" id="noexpresonovisitar">NO</label><br><br>
			<label id="motivonovisitar">Si la persona no dijo "NO QUIERO QUE ME VUELVAN A VISITAR", ¬øPor qu√© consider√°s que no deber√≠amos volver?. ¬øQu√© te dijo y c√≥mo actu√≥?  <input id="detallemotivonovisitar" placeholder="Indic√° en detalles lo que te dijo e hizo la persona..." style="width:80%;"></label>
			<label id="leyendadetallemotivonovisitar">Por favor, describ√≠ lo m√°s claramente posible lo que te dijeron para evaluar si a√±adimos la casa a la lista de NO VISITAR.-</label>
			<br>
			<pre id="enviandoreportenovisitar" style="font-family: 'Arial'; font-weight: bold;"></pre>
			<div style="text-align: center">
				<button id="btn-cerrar-reportenovisitar" style="height:35px; width:30%; background-color:red;border-color:white;color:white;" onclick="CerrarModalNoVisitar()">Cerrar</button>
				<button id="btn-enviar-reportenovisitar" style="height:35px; width:30%; background-color:green;border-color:white;color:white;">Enviar</button>
			</div>
		</div>
	</div>
	
	<!--Bloque para el Calendario-->
    <!-- Modal Calendario -->
	<div id="ModalCalendario" class="capaoscura">
		<div id="modal1" class="modales">
			<div class="modalcal-cabecera">
				<div class="modalcal-titulo" id="TituloCalendario">Calendario</div>
				<button class="modalcal-cerrar" onclick="CerrarModalCalendario('modal1')">‚úï</button>
			</div>
			<div class="calendario">
				<div class="calendario-grid" id="diasdelasemana"></div>
				<div class="calendario-grid" id="dias"></div>
				<div class="calendario-encabezado">
					<span id="mesactual"></span>
					<!--<button class="boton-calendario" id="BorrarFecha" style="padding:6px 10px;font-size:12px"></button>-->
				</div>
			</div>
		</div>
		<!--Modal Salidas-->
		<div id="modal2" class="modales" style="display:none;">
			<div class="modalsal-cabecera">
				<div class="modalsal-titulo" id="titulo-modalsal"></div>
				<button class="modalsal-cerrar" onclick="CerrarModalCalendario('modal2')">‚úï</button>
			</div>
			<div class="infosalidas" id="DetallesSalidas"></div>
		</div>
	</div>

	<!-- capa captura clicks fuera -->
	<div id="capa" class="capa" aria-hidden="true"></div>

	<!-- la gu√≠a/modal con flecha (se posiciona con JS) -->
	<div id="cartelnuevo" class="novedad" role="dialog" aria-modal="true" style="display:none">
		<p style="color:green";>Esta versi√≥n, ya muestra los territorios</p>
		<p style="color:green";>actualizados en enero 2026.</p>
		<p style="color:green";>Por otra parte, record√° que</p>
		<p style="color:green";>las herramientas que estaban en la pantalla,</p>
		<p style="color:green";>ahora est√°n ordenadas dentro de esta barra.</p>
		<p style="color:green";>As√≠, tendr√°s m√°s espacio para ver mejor el mapa.</p>
		<br></br>
		<label id="borrablelonuevo">
			<input id="nomostrarlonuevo" type="checkbox" style="width:16px; height:16px;"/>
			No volver a mostrar
		</label>
	</div>
	
</body>
	<!--Ventana modal inicial-->
	<dialog id="modal_inicial" style="text-align: center; background-color:yellow; font-size:13px;">
		<div id="Apaisado">
			<span id="titulo_modalinicial"><h4>Parece que est√°s usando un dispositivo movil (celular o tablet).</h4></span>
			<br><br/>
			<span id="cuerpo_modalinicial"><h4>En caso que no veas los mensajes completos o todas las herramientas,<br/>prob√° de girar la pantalla. Eso har√° que tengas una mejor visi√≥n del mapa y sus herramientas.-</h4>
			<br/>Record√° que en todo momento dispon√©s de distintas herramientas sobre la barra lateral izquierda.<br/>¬øQuer√©s saber c√≥mo funcionan? Toc√° las tres l√≠neas de su parte superior y recibir√°s ayuda.</span>
		</div>
		<div id="Conectividad">
			<span id="titulo_modalconectividad"><h4>Parece que no ten√©s conexi√≥n a Internet.</h4></span>
			<span id="cuerpo_modalconectividad"><h2><br/>Por favor solucion√° eso porque algunas herramientas no funcionar√°n correctamente.</h2></span>
		</div>
		<div style="text-align: right">
			<label id="borrablecelular">
				<input id="nomostrarcelular" type="checkbox" style="width:16px; height:16px;"/>
				No volver a mostrar
			</label>
			<button id="btn-cerrar-modal-inicial" style="height:30px; width:90px; background-color:red;border-color:white;color:white">Cerrar</button>
		</div>
	</dialog>
	<script>
		var Version = "2"; //Cambiar este valor para volver a mostrar el modal de presentacion cada vez que haya una actualizacion importante
		<!--Mapas o capas bases-->
		var osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			attribution: 'Teselas <a href="https://www.openstreetmap.org/" target="blanck">OSM</a> &copy|Versi√≥n: '+Version,
			minZoom: 1
		});
		var googlesatelite=L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
			attribution: 'Teselas <a href="https://www.google.com.ar/maps/@-21.5405995,-63.9542602,11544855m/data=!3m1!1e3?entry=ttu" target="blanck">Google Satelital</a> &copy|Versi√≥n: '+Version,
		});
		<!--Establecer el √°rea para el mapa y definir cu√°l ser√° la capa base por defecto-->
		var mapa = L.map('mapa', {editable:true,
			center: ["-32.9280586817747", "-68.77360525273423"],
			zoom: 15,
			layers: [osm],
			zoomControl:false
		});
		const zoomControl = L.control.zoom({ position: 'topright' }).addTo(mapa);
		<!--A√±adir el mini-mapa al lienzo-->
		<!--var worldMiniMap = L.control.worldMiniMap({position: 'bottomright', style: {opacity: 0.9, borderRadius: '0px', backgroundColor: 'lightblue'}}).addTo(mapa);-->
		$('.chosenCasas').chosen({no_results_text: "No se encuentran familias ni publicadores de nombre...",allow_single_deselect: true});
        $(".chosenCasas").chosen().on("chosen:showing_dropdown", function(event) {  
			$(".chosenCasas").trigger('chosen:updated');                                                                           
			});
		var coordenadas="-32.9280586817747, -68.77360525273423".split(",");
		var zum=16;
		var selector_casas=document.createElement('option');
		var listacasas=[];
		var valor="";
		var firstLatLng, secondLatLng;
		var conexion="";
		var circulo="";
		var version="publica";
		var marcador="";
		var seguimiento="no";
		var casa="";
		var casitas="";
		var casas=[];
		var capa_casas={};
		var capabase="osm";
		var familia="";
		var ubicacion_real="";
		var borrar_ubicacion_real="";
		var sondeo_posicion=0;
		var senialgps="";
		var lat="";
		var lon="";
		var buscar="territorio";
		var distancia="";
		var lugar="";
		var dentropredio="";
		var nada=L.layerGroup();
		var barrio=null;
		var no_visitar=null;
		var poligono="";
		var capa_infoterritorios={};
		var capa_coloresterritorios={};
		var capa_numerosterritorios={};
		var capa_territoriofiltrado={};
		var capa_territoriofiltradonumero={};
		var puntomascercano=L.latLng[-32.92740078150927, -68.77696817942217];
		var numeroterritorio="";
		var capa_popups=null;
		var infoterritorios=null;
		var infoterritorio=null;
		var orientarme="";
		var ruta="";
		var actualizarruta="si";
		var coordenadas_ubicacion_real="";
		var icono_posicion = L.icon({iconUrl: './images/posicion.png',iconSize: [35, 40],});
		var tiempomodalflash=20000;
		var temporizadormodalflash="";
		var temporizadornovisitar="";
		var temporizadorpredicado="";
		var mes_anio="";
		var diaseleccionado="";
		var messeleccionado="";
		var anioseleccionado="";
		var fecha="";
		var marcapuntosalida="";
		var cartografiar="congregacion";
		var listaterritorios=[];
		var dispositivo="";
		var url_script_territorios=driveterritorios;
		var url_script_novisitar=drivenovisitar;
		var url_script_contadorvisitas=drivecontadorvisitas;
		var intervalo=null;
		var tiempo=null;
		var intervaloRuta = "";
		
		//Capturar evento sobre botones
		const btncerrarmodalflash=document.querySelector("#btn-cerrar-modal-flash");
		const btnindicacionesmodalflash=document.querySelector("#btn-indicaciones-modal-flash");
		const cajadistancia = document.getElementById("distancia");
		const btncerrarmodalinicial=document.querySelector("#btn-cerrar-modal-inicial");
		const modalinicial=document.querySelector("#modal_inicial");
		const nomostrarinicial = document.getElementById('nomostrarinicial');
		const nomostrarcelular = document.getElementById('nomostrarcelular');
		const nomostrarlonuevo = document.getElementById('nomostrarlonuevo');
		const botondetallesruta =document.getElementById("BotonDetallesRuta");
		const panelrutas=document.getElementById("PanelRutas");
		const mimodalflash=document.querySelector("#MiModalFlash");
		let refrescoRutaActivo = false;
		
		// Crear grupo de puntos
		var grupomanzanas = L.geoJSON(manzanas, {
			pointToLayer: function(feature, latlng) {
				// Crear un c√≠rculo
				const circle = L.circleMarker(latlng, {
					radius: 14,
					fillColor: "#0078ff",
					color: "#fff",
					weight: 2,
					opacity: 1,
					fillOpacity: 0.8
				});
				// Agregar un div centrado con el texto de "manzana"
				const label = L.divIcon({
					className: 'circle-label',
					html: feature.properties.Manzana || '',
					iconSize: [40, 40],
					iconAnchor: [15, 15]
				});
				const labelMarker = L.marker(latlng, {icon: label, interactive: false});
				// Devolver ambos dentro de un grupo
				return L.layerGroup([circle, labelMarker]);
			}
		});

		<!--A√±adir la barra lateral-->
		var barralateral = L.control.sidebar('barralateral').addTo(mapa);
		
		const iconosterritorios= L.icon({
			iconUrl: 'images/1.jpg',
			iconSize: [50, 55],
			iconAnchor: [16, 37],
			popupAnchor: [0, -28]
		});
		
		function AlternarCapas() {
			barralateral.close();
			if (capabase=="osm") {mapa.removeLayer(osm);capabase="googlesatelite";googlesatelite.addTo(mapa)}
			else {mapa.removeLayer(googlesatelite);capabase="osm";osm.addTo(mapa)};
		};
		
		function Contrasenia () {
			var estado=document.getElementById("password").type;
			var valor=document.getElementById("password").value;
			if (estado=="password") {document.getElementById("password").type="text";}
			else {document.getElementById("password").type="password"};
			document.getElementById("password").value = valor;
		};
		
		function Loguearse() {
			usuario=document.getElementsByName("username")[0].value;
			contrasena=document.getElementsByName("password")[0].value;
			if (usuario==usuarios && contrasena==contrasenias) {
				barralateral.close();
				document.getElementById("casas_hnos").style.display='inline';
				document.getElementById("ayuda_usuario").style.display='inline';
				document.getElementById("log_si").style.display='inline';
				document.getElementById("log_no").style.display='none';}
			else {
				document.getElementById("titulo_modalinicial").innerHTML=("<h1>"+"DATOS INCORRECTOS...!!!"+"</h1>");
				document.getElementById("cuerpo_modalinicial").innerHTML=("<h4>"+"El usuario y/o la contrase√±as NO son las correctas...!!!"+"</h4>");
				//document.getElementById("modal_inicial").showModal();
				modalinicial.showModal();
			};
		};
		
		function CerrarSesion() {
			if (casa) {casa.remove()};
			if (casitas) {casitas.remove()};
			if (ruta) {ruta.remove()};
			if (capa_casas) {mapa.removeLayer(capa_casas)};
			document.getElementById("casas_hnos").style.display='none';
			document.getElementById("ayuda_usuario").style.display='none';
			document.getElementById("log_si").style.display='none';
			document.getElementById("log_no").style.display='inline';
			document.getElementById("username").value="";
			document.getElementById("password").value="";
			barralateral.close();
		};
		
		<!--Funci√≥n Mostrar/Habilitar u Ocultar/Deshabilitar elementos seg√∫n la versi√≥n de trabajo-->
		function VerificarVersion() {
			if (version=="publica") {
				document.getElementById("casas_hnos").style.display='none';
				document.getElementById("ayuda_usuario").style.display='none';
				document.getElementById("log_si").style.display='none';
				document.getElementById("log_no").style.display='inline';
			};
			if (version=="completa") {
				document.getElementById("casas_hnos").style.display='inline';
				document.getElementById("ayuda_usuario").style.display='inline';
				document.getElementById("log_si").style.display='inline';
				document.getElementById("log_no").style.display='none';
			};
		};
		
		<!--Funci√≥n para mapear todas las familias-->
		function VerTodasFlias() {
			barralateral.close();
			if (capa_casas) {mapa.removeLayer(capa_casas)};
			buscar="casa";
			capa_casas = L.geoJson(casasdehnos, {onEachFeature}).addTo(mapa);
			document.getElementById("ocultarflias").style.display="inline";
			document.getElementById("mostrarflias").style.display="none";
		};
		
		<!--Funci√≥n para mapear todas las familias-->
		function QuitarTodasFlias() {
			capa_casas.remove();
			capa_casas={};
			if (casa !="") {casa.remove()};
			casa="";
			if (casitas !="") {casitas.remove()};
			casitas="";
			casas=[];
			barralateral.close();
			document.getElementById("mostrarflias").style.display="inline";
			document.getElementById("ocultarflias").style.display="none";
		};
		
		<!--Funci√≥n armado de los Popups de las casas-->
		function Popups_Casas(feature, layer) {
			if (feature.properties && feature.properties.Flia) {
				layer.bindPopup(feature.properties.Flia);
				listacasas.push(feature.properties.Flia)};
		};
		function Popups_Territorios(feature, layer) {
			if (feature.properties && feature.properties.Numero) {
				if (feature.properties.Barrio !==null) {
					var barrio=feature.properties.Barrio}
				else {
					var barrio="Sin informaci√≥n"
				};
				if (feature.properties.No_Visitar !==null) {
					var novisitar=feature.properties.No_Visitar}
				else {
					var novisitar="No hay casas 'NO VISITAR' en este territorio"
				};
				listaterritorios.push(feature.properties.Numero);
				let sinRepetidos = [...new Set(listaterritorios)];
				listaterritorios=sinRepetidos.sort((a, b) => a - b);
				layer.bindPopup("<strong>Territorio N¬∫ "+feature.properties.Numero+"</strong>"+"<br>Barrio: "+barrio+"<br><br><strong>NO VISITAR:</strong><br>"+novisitar);
			};
			//ArmarListaTerritorios();
		};
		
		function NumerosTerritorios(feature, layer) {
			if (feature.properties && feature.properties.Numero) {
				if (feature.properties.Barrio !==null) {
					var barrio=feature.properties.Barrio}
				else {
					var barrio="Sin informaci√≥n"
				};
				if (feature.properties.No_Visitar !==null) {
					var novisitar=feature.properties.No_Visitar}
				else {
					var novisitar="No hay casas 'NO VISITAR' en este territorio"
				};
				var centroide=layer.getBounds().getCenter();
				var coord=[];
				coord.push(centroide.lat,centroide.lng);
				let terri=L.marker(coord,{icon:L.icon({iconUrl: 'images/'+feature.properties.Numero+'.jpg',iconSize: [50, 55],iconAnchor: [16, 37],popupAnchor: [0, -28]}),title:""+feature.properties.Numero})
					.bindPopup("<strong>Territorio N¬∫ "+feature.properties.Numero+"</strong>"+"<br>Barrio: "+barrio+"<br><br><strong>NO VISITAR:</strong><br>"+novisitar);
				nada.addLayer(terri);
				nada.addTo(mapa);
			};
		};
		
		function NumeroTerritorio(feature, layer) {
			if (feature.properties && feature.properties.Numero) {
				if (feature.properties.Barrio !==null) {
					var barrio=feature.properties.Barrio}
				else {
					var barrio="Sin informaci√≥n"
				};
				if (feature.properties.No_Visitar !==null) {
					var novisitar=feature.properties.No_Visitar}
				else {
					var novisitar="No hay casas 'NO VISITAR' en este territorio"
				};
				var centroide=layer.getBounds().getCenter();
				var coord=[];
				coord.push(centroide.lat,centroide.lng);
				numeroterritorio=L.marker(coord,{icon:L.icon({iconUrl: 'images/'+feature.properties.Numero+'.jpg',iconSize: [50, 55],iconAnchor: [16, 37],popupAnchor: [0, -28]}),title:""+feature.properties.Numero})
					.bindPopup("<strong>Territorio N¬∫ "+feature.properties.Numero+"</strong>"+"<br>Barrio: "+barrio+"<br><br><strong>NO VISITAR:</strong><br>"+novisitar).addTo(mapa);
			};
		};
		
		var capa="territorios";
		capa_coloresterritorios = L.geoJson(territorios, {style: PersonalizarPerimetro}).addTo(mapa);
		capa_numerosterritorios = L.geoJson(territorios, {onEachFeature: NumerosTerritorios}).addTo(mapa);
		capa_infoterritorios = L.geoJson(territorios, {style: CapaTransparente, onEachFeature: Popups_Territorios}).addTo(mapa);
		geojson = L.geoJson(casasdehnos, {onEachFeature: Popups_Casas}).addTo(mapa);
		geojson.remove();
		//Capa con L√≠neas L√≠mites Perimetrales
		limites= L.geoJSON(perimetrolineal, {
			style: {
				color: "orange",
				weight: 6
			},
			onEachFeature: (feature, layer) => {
			const nombre = feature.properties?.Nombre || "Sin nombre";
			const limite=feature.properties?.Limite || "Sin dato";
			// Evento de click para abrir popup en el punto clickeado
			layer.on("click", (e) => {
			L.popup()
			.setLatLng(e.latlng)
			.setContent(`<strong>${nombre}</strong><br>L√≠mite ${limite}`)
			.openOn(mapa);
			});
			}
		}).addTo(mapa);
		listacasas.sort();
		ArmarListaCasas(listacasas);
		
		<!--Funci√≥n para armar el listado de casas y asignarlo al listbox correspondiente-->
		function ArmarListaCasas(listacasas) {
			var select = document.getElementById('selector_casas');
			var i;
			for (i = 0; i < listacasas.length; i++) {
				var opt = listacasas[i];
				var el = document.createElement("option");
				el.textContent = opt;
				el.value = opt;
				select.appendChild(el);
			};
		};
		
		<!--Funci√≥n para armar el listado de territorios y asignarlo al listbox correspondiente-->
		function ArmarListaTerritorios() {
			var select = document.getElementById('selector_territorios');
			var i;
			for (i = 0; i < listaterritorios.length; i++) {
				var opt = listaterritorios[i];
				var el = document.createElement("option");
				el.textContent = opt;
				el.value = opt;
				select.appendChild(el);
			};
		};
		
		<!--Funci√≥n buscar casa elegida-->
		function CasaAbuscar(valor) {
			barralateral.close();
			familia=valor;
			casas.push(familia);
			buscar="casa";
			if (capa_coloresterritorios) {mapa.removeLayer(capa_coloresterritorios)};
			if (capa_numerosterritorios) {mapa.removeLayer(capa_numerosterritorios)};
			if (capa_infoterritorios) {mapa.removeLayer(capa_infoterritorios)};
			if (nada) {mapa.removeLayer(nada)};
			if (capa_territoriofiltrado) {mapa.removeLayer(capa_territoriofiltrado)};
			if (capa_territoriofiltradonumero) {mapa.removeLayer(capa_territoriofiltradonumero)};
			if (numeroterritorio) {mapa.removeLayer(numeroterritorio)};
			if (marcapuntosalida) {marcapuntosalida.remove()};
			if (ruta) {ruta.remove()};
			if (capa_casas) {mapa.removeLayer(capa_casas)};
			capa_casas=L.geoJSON(casasdehnos,{filter:Filtrar_Casas,onEachFeature}).addTo(mapa);
			nada={
				"type": "FeatureCollection",
				"features": casasdehnos.features.filter(f => f.properties.Flia === valor)
			};
			puntomascercano=L.latLng(nada.features[0].geometry.coordinates[0][1],nada.features[0].geometry.coordinates[0][0]);
			cartografiar="casa";
			if (seguimiento==="si") {
				alert("Ac√°... 1!!!");
				titulomodalflash.innerText="TRAZAR RUTA";
				cuerpomodalflash.innerHTML = '<span style="color:green"><br><b>¬øNecesit√°s ayuda para llegar?.</b><br><br><span style="color:black">Puedo trazarte una ruta '+
				'a partir de tu ubicaci√≥n actual y brindarte algunas indicaciones.-<br></span>';
				btnindicacionesmodalflash.style.display='flex';
				tiempomodalflash=5000;
				ModalFlash(tiempomodalflash);
			};
		};
		
		<!--Funci√≥n buscar territorio elegido-->
		function TerritorioAbuscar(numeroterritoriobuscado,tipo) {
			valor=Number(numeroterritoriobuscado);
			barralateral.close();
			buscar="territorio";
			if (capa_coloresterritorios) {mapa.removeLayer(capa_coloresterritorios)};
			if (capa_numerosterritorios) {mapa.removeLayer(capa_numerosterritorios)};
			if (capa_infoterritorios) {mapa.removeLayer(capa_infoterritorios)};
			if (nada) {mapa.removeLayer(nada)};
			if (capa_territoriofiltrado) {mapa.removeLayer(capa_territoriofiltrado)};
			if (capa_territoriofiltradonumero) {mapa.removeLayer(capa_territoriofiltradonumero)};
			if (numeroterritorio) {mapa.removeLayer(numeroterritorio)};
			if (marcapuntosalida && ! cartografiar==="salida") {marcapuntosalida.remove()};
			if (capa_casas) {mapa.removeLayer(capa_casas)};
			if (casa) {casa.remove()};
			if (casitas) {casitas.remove()};
			if (ruta) {ruta.remove()};
			capa_territoriofiltrado=L.geoJSON(territorios,{filter:Filtrar_Territorios, style:PersonalizarTerritorioBuscado}).addTo(mapa);
			poligono = {
				"type": "FeatureCollection",
				"features": territorios.features.filter(f => f.properties.Numero === valor)
			};
			if (tipo==="territorio") {
				var centroide=capa_territoriofiltrado.getBounds().getCenter();
				var coord=[];
				coord.push(centroide.lat,centroide.lng);
				mapa.flyTo(coord,16);
				cartografiar="territorio";
				puntomascercano = [centroide.lat, centroide.lng];
			};
			if (tipo==="salida") {
				cartografiar="salida";
			};
			capa_territoriofiltradonumero=L.geoJSON(territorios,{filter:Filtrar_Territorios, onEachFeature: NumeroTerritorio}).addTo(mapa);
			if (capa_infoterritorios) {capa_infoterritorios.addTo(mapa)};
			if (seguimiento==="si") {
				alert("Ac√° 1...!!!");
				titulomodalflash.innerText="TRAZAR RUTA";
				cuerpomodalflash.innerHTML = '<span style="color:green"><br><b>¬øNecesit√°s ayuda para llegar?.</b><br><br><span style="color:black">Puedo trazarte una ruta '+
				'a partir de tu ubicaci√≥n actual y brindarte algunas indicaciones.-<br></span>';
				btnindicacionesmodalflash.style.display='flex';
				tiempomodalflash=5000;
				ModalFlash(tiempomodalflash);
			};
		};
		
		function Filtrar_Casas(feature) {
			if (capa_casas) {mapa.removeLayer(capa_casas)};
			for (i = 0; i < casas.length; i++) {
				if (feature.properties.Flia==casas[i]) {return true};
			};
			document.getElementById("ocultarflias").style.display="inline";
			document.getElementById("mostrarflias").style.display="inline";
		};
		
		function Filtrar_Territorios(feature) {
			if (valor !="") {if (feature.properties.Numero==valor) return true};
		};
		
		function ColorFondo(d) {
			return (d == 1 || d==9 || d==15 || d==22 || d==29 || d==36 || d==43 || d==50) ? 'red':
			(d== 2 || d==16 || d==30 || d==37 || d==44 || d==51) ? 'blue':
			(d== 3 || d==8 || d==10 || d==13 || d==17 || d==24 || d==31 || d==38 || d==45 || d==52) ? 'yellow':
			(d== 4 || d==11 || d==18 || d==25 || d==32 || d==39 || d==46 || d==53) ? 'pink':
			(d== 5 || d==12 || d==16 || d==19 || d==23 || d==26 || d==33 || d==40 || d==47 || d==54) ? 'cyan':
			(d== 6 || d==13 || d==20 || d==27 || d==34 || d==41 || d==48 || d==55) ? 'green':
			(d== 7 || d==14 || d==21 || d==28 || d==35 || d==42 || d==49 || d==56) ? 'brown':
			'black'
		};

		<!--Funcion para colorear per√≠metro cultivos/edificios-->
		function ColorPerimetro(d) {
			return d < 100? 'white':
				'black'
		};

		<!--Funcion para llamar subfunciones de coloreo per√≠metros y √°reas-->
		function PersonalizarPerimetro(feature) {
			return {
				fillColor: ColorFondo(feature.properties.Numero),
				weight: 4,
				opacity: 1,
				color: ColorPerimetro(feature.properties.Numero),
				dashArray: '3',
				fillOpacity: 0.3}
		};
		
		//Funci√≥n para colorear el territorio buscado
		function PersonalizarTerritorioBuscado(feature) {
			return {
				fillColor: "#020259",
				weight: 4,
				opacity: 1,
				color: "#46fafa",
				dashArray: '3',
				fillOpacity: 0.3}
		};
			
		//Funci√≥n para generar capa transparente con info de cada teritorio
		function CapaTransparente(feature) {
			return {
				interactive: true,          // que respondan a eventos
				color: '#000000',         // borde (da igual el color si es transparente)
				opacity: 0,               // borde 100% transparente
				weight: 2,                // mantener >0 ayuda al hit-test del borde
				fillColor: '#000000',
				fillOpacity: 0.001}        // ~invisible pero clickeable (0 puede dificultar eventos)
		};
		
		//Funci√≥n para recorrer cada elemento de la capa dada
		function onEachFeature(feature, layer) {
			if (buscar=="territorio") {
				coord_territorio=(feature.geometry.coordinates[0][1]+", "+feature.geometry.coordinates[0][0]).split(",");
				var centroide=layer.getBounds().getCenter();
				var coord=[];
				coord.push(centroide.lat,centroide.lng);
				mapa.flyTo(coord,18);
				if (feature.properties.Barrio !==null) {
					var barrio=feature.properties.Barrio}
				else {
					var barrio="Sin informaci√≥n"
				};
				if (feature.properties.No_Visitar !==null) {
					var novisitar=feature.properties.No_Visitar}
				else {
					var novisitar="No hay casas 'NO VISITAR' en este territorio"
				};
			}
			else {
				var formatoPopup = {
					'maxWidth': '600',
					'className' : 'popups'};
				<!--Establecer la foto del frente de la casa-->
				var nom_foto="";
				nombrefoto=(feature.properties.Flia).split(" ");
				nombrefoto.forEach(nombre => nom_foto=nom_foto+nombre+"_");
				nombrefoto = nom_foto.slice(0, nom_foto.length - 1);
				<!--Establecer qu√© familias tienen fotos del frente de su casa y cu√°les no para distinguir qu√© imagen mostrar-->
				if (nombrefoto=="Andrada_Liliana" || nombrefoto=="Arg√ºello" || nombrefoto=="Astudillo_Elio-Videla_Alejandro" || nombrefoto=="Astudillo_Jonatan" || nombrefoto=="Battaglia" || nombrefoto=="Biscontin_Irma" || nombrefoto=="Biscontin_Ruben"
				|| nombrefoto=="Bringas" || nombrefoto=="Bustos_Ethel" || nombrefoto=="Caba√±ez_Carlos" || nombrefoto=="Calderon-Andrada" || nombrefoto=="Candia" || nombrefoto=="Castillo" || nombrefoto=="Cinco-Castillo"
				|| nombrefoto=="Del_Balzo" || nombrefoto=="Ferranti-Ricalde" || nombrefoto=="Figueroa" || nombrefoto=="Galdames" || nombrefoto=="Garcia_Cristian" || nombrefoto=="Garcia_Gonzalo" || nombrefoto=="Garcia_Roberto"
				|| nombrefoto=="Godoy" || nombrefoto=="Gualpa" || nombrefoto=="Huallpa" || nombrefoto=="Leites" || nombrefoto=="Manresa" || nombrefoto=="Miron_Daniel" || nombrefoto=="Miron_Gustavo" || nombrefoto=="Mu√±oz"
				|| nombrefoto=="Nu√±ez_Alejandro" || nombrefoto=="Nu√±ez_Estela" || nombrefoto=="Ortiz_Elias" || nombrefoto=="Ortiz_Hector" || nombrefoto=="Ortiz_Jose" || nombrefoto=="Quiroga_Jose"
				|| nombrefoto=="Quiroga-Ramirez" || nombrefoto=="Reyes" || nombrefoto=="Rossi" || nombrefoto=="Sarmiento" || nombrefoto=="Snieg" || nombrefoto=="Sosa_Noelia" || nombrefoto=="Sosa_Tamara"
				|| nombrefoto=="Vera_Debora" || nombrefoto=="Vera_Natalia") {var foto='./images/'+nombrefoto+".jpg";
				} else {
					var foto='./images/'+'Casa.jpg';
				};
				if (feature.properties.Integrante !=null) {var integrantes=feature.properties.Integrante} else {var integrantes="Sin datos"};
				if (feature.properties.Privilegio !=null) {var privilegios=feature.properties.Privilegio} else {var privilegios="Sin datos"};
				if (feature.properties.Direccion !=null) {var direccion=feature.properties.Direccion} else {var direccion="Sin datos"};
				if (feature.properties.Telefono !=null) {var telefono=feature.properties.Telefono} else {var telefono="Sin datos"};
				var contenidoPopup="<img src="+foto+" width='90' height='90' /img><br><strong>Flia. "+feature.properties.Flia+"</strong><br>Integrantes: "+integrantes+"<br>Privilegios: "+privilegios+"<br>Direcci√≥n: "+direccion+"<br>Tel√©fono: "+telefono;
				if (feature.properties.Flia==familia) {
					if (casa !=[]) {casa.remove()};
					coord_casa=(feature.geometry.coordinates[0][1]+", "+feature.geometry.coordinates[0][0]).split(",");
					mapa.flyTo(coord_casa,zum);
					casa=L.marker(coord_casa).addTo(mapa)
						.bindPopup(contenidoPopup)
						.openPopup();
				};
				casitas=layer.bindPopup(contenidoPopup)
					.openPopup();
			};
		};
		
		<!--Verificar Sistema Operativo-->
		function VerificarDispositivo() {
			const ancho = window.screen.width;
			const alto = window.screen.height;
			if (Math.min(ancho, alto) < 768) {so="movil"}  // tel√©fonos y tablets
			else {so="pc"};
			dispositivo=so;
			if (dispositivo=="pc") {document.getElementById("botonnorte").style.visibility="visible"};
		};
		
		VerificarDispositivo();
		
		<!--Funcion para verificar estado de conectividad-->
		function VerificarConexion() {
			const online = navigator.onLine;
			online ? conexion="si" : conexion="no";
			if (conexion=="no") {
				titulomodalflash.innerText="SIN CONEXION";
				cuerpomodalflash.innerHTML = '<span style="color:red"><br><b>No hay conexi√≥n a interntet.</b><br><br><span style="color:black">Por favor, busca la manera de conectarte para poder usar este visor web.</span>';
				tiempomodalflash=4000;
				ModalFlash(tiempomodalflash);
			};
		};

		<!--Funci√≥n para verificar GPS-->
		function VerificarGPS() {
			<!--Sin GPS-->
			if (!navigator.geolocation) {
				titulomodalflash.innerText="SIN GPS";
				cuerpomodalflash.innerHTML = '<span style="color:red"><br><b>Oho...!!!.</b><br><br><span style="color:black">Parece que tu navegador o dispositivo no funciona con GPS...!!!.-<br>'+
				'Por lo tanto, no podr√°s ver tu ubicaci√≥n en tiempo real.</span>';
				tiempomodalflash=5000;
				ModalFlash(tiempomodalflash);
				senialgps="no";
			};
			if (!dispositivo==="pc") {navigator.geolocation.getCurrentPosition(
				<!--GPS Perfecto-->
				(pos) => {
					senialgps="si";
					const lat = pos.coords.latitude.toFixed(6);
					const lon = pos.coords.longitude.toFixed(6);
					const accuracy = pos.coords.accuracy;
					//alert(`‚úÖ GPS activo\nLatitud: ${lat}\nLongitud: ${lon}\nPrecisi√≥n: ${accuracy} metros`+pos.coords.latitude+pos.coords.longitude);
					//MarcarUbicacion(pos);
				},
				<!--Alg√∫n problema con el GPS-->
				(error) => {
					senialgps="no";
					msg="‚ùå No se pudo acceder al GPS";
					if (error.code === 1) msg1 = "‚ùå Permiso de ubicaci√≥n denegado";
					else if (error.code === 2) msg1 = "‚ùå Posici√≥n no disponible";
					else if (error.code === 3) msg1 = "‚ùå Tiempo de espera agotado";
					titulomodalflash.innerText="SIN GPS";
					cuerpomodalflash.innerHTML = '<span style="color:red"><br><b>Oho...!!!.</b><br><br><span style="color:black">'+msg+'...!!!.-<br>'+
					'Debido a: '+msg1+'.-</span>';
					tiempomodalflash=5000;
					ModalFlash(tiempomodalflash);
					botondetallesruta.style.display="none";
				},
				{
					enableHighAccuracy: true,
					timeout: 5000,
					maximumAge: 0
				}
			)};
		};
		
		function activar_seguimiento() {
			sondeo_posicion=0;
			barralateral.close();
			document.getElementById("gps").src="./images/slide_on.jpg";
			document.getElementById("activargps").style.visibility='hidden';
			document.getElementById("ubicacion_estado").href="javascript:desactivar_seguimiento()";
			VerificarConexion();
			if (conexion==="si") {
				VerificarGPS();
				if ((dispositivo=="pc") && orientarme=="") {
					titulomodalflash.innerText="TRAZAR RUTA";
					cuerpomodalflash.innerHTML = '<span style="color:red"><br><b>Puede que la ubicaci√≥n que te muestre NO SEA LA REAL.</b><br><br><span style="color:black">Parece que est√°s conectado desde una PC; por lo que la ubicaci√≥n tal vez sea la de tu proveedor de internet; en vez del lugar donde est√°s.-<br></span>';
					btnindicacionesmodalflash.style.display='none';
					btncerrarmodalflash.textContent="Cerrar";
					tiempomodalflash=9000;
					ModalFlash(tiempomodalflash);
				};
				if (dispositivo==="pc") {botoncentrado.style.display='block'};
				cajadistancia.classList.add("visible");
				seguimiento="si";
				//document.getElementById("miubicacion").style.visibility='visible';
				mapa.locate({setView: false, watch: true, enableHighAccuracy: true});
				mapa.on('locationfound', ActualizarUbicacion);
				mapa.on('locationerror', ErrorGPS);
			};
		};

		// Evento al encontrar la ubicaci√≥n	
		function ActualizarUbicacion(e) {
			if (coordenadas_ubicacion_real) {
				mapa.removeLayer(marca_ubicacion_real);
				marca_ubicacion_real = L.marker(e.latlng,{icon:icono_posicion}).addTo(mapa)
					.bindPopup("Vas por aqu√≠");
				coordenadas_ubicacion_real=e.latlng;
			};
			if (!coordenadas_ubicacion_real) {
				marca_ubicacion_real = L.marker(e.latlng,{icon:icono_posicion}).addTo(mapa)
					.bindPopup("Est√°s por aqu√≠")
					.openPopup();
				coordenadas_ubicacion_real=e.latlng;
				mapa.setView(coordenadas_ubicacion_real, 17);
			};
			//document.getElementById("vermiubicacion").style.visibility='visible';
			dentro = ChequearPredio(coordenadas_ubicacion_real);
			distancia=DistanciaEnTiempoReal();
			<!-- if (!dentro || dentro==null) { -->
				<!-- dentropredio=""} else {dentropredio="si"}; -->
			<!-- if (orientarme=="no" && dentropredio=="") { -->
				<!-- titulomodalflash.innerText="TRAZAR RUTA"; -->
				<!-- cuerpomodalflash.innerHTML = '<span style="color:green"><br><b>¬øNecesit√°s ayuda para llegar?.</b><br><br><span style="color:black">Puedo trazarte una ruta '+ -->
				<!-- 'a partir de tu ubicaci√≥n actual y brindarte algunas indicaciones.-<br></span>'; -->
				<!-- document.getElementById("btn-indicaciones-modal-flash").style.visibility='visible'; -->
				<!-- tiempomodalflash=5000; -->
				<!-- ModalFlash(tiempomodalflash); -->
			<!-- }; -->
			<!-- if (orientarme=="no" && dentropredio=="si" && distancia>7) { -->
				<!-- titulomodalflash.innerText="TRAZAR RUTA"; -->
				<!-- cuerpomodalflash.innerHTML = '<span style="color:green"><br><b>¬øNecesit√°s ayuda para llegar?.</b><br><br><span style="color:black">Puedo mostrarte en tiempo real por d√≥nde vas '+ -->
				<!-- 'y el destino con vista de ambos puntos en el mapa.-<br></span>'; -->
				<!-- document.getElementById("btn-indicaciones-modal-flash").style.visibility='visible'; -->
				<!-- tiempomodalflash=5000; -->
				<!-- ModalFlash(tiempomodalflash); -->
			<!-- }; -->
			<!-- if (orientarme=="si" && (dentropredio=="" || capa_territoriofiltrado)) {cajadistancia.classList.add("visible")}; -->
			<!-- if (distancia > 7 && orientarme=="si") { -->
				<!-- cajadistancia.classList.add("visible"); -->
				<!-- if (distancia>6000) {msg="¬°Est√°s a unos "+(Math.round(distancia/1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, "."))+" kil√≥metros del destino! (En l√≠nea recta).-"}; -->
				<!-- if (distancia<6001) {msg="¬°Est√°s a unos "+(Math.round(distancia).toString().replace(/\B(?=(\d{3})+(?!\d))/g, "."))+" metros del destino! (En l√≠nea recta).-"}; -->
				<!-- cajadistancia.textContent = msg; -->
				<!-- cajadistancia.style.background = "#d4edda"; -->
				<!-- cajadistancia.style.color = "#155724"; -->
			<!-- }; -->
			<!-- if (distancia <= 7 && orientarme=="si") { -->
				<!-- setTimeout(() => { -->
					<!-- //cajadistancia.style.opacity = "0"; -->
					<!-- //cajadistancia.style.visibility="visible"; -->
					<!-- cajadistancia.classList.add("visible"); -->
					<!-- cajadistancia.textContent = "¬°Has llegado a tu destino!"; -->
					<!-- cajadistancia.style.background = "#d4edda"; -->
					<!-- cajadistancia.style.color = "#155724"; -->
					<!-- setTimeout(()=> elemento.style.display = "none", 1000); // espera al fade-out -->
				<!-- }, 10000); -->
			
				<!-- if (avisollegada==="si") {AlertaLlegada("Has llegado a tu destino")}; -->
			<!-- }; -->
			if (orientarme=="") {
				if (distancia>1100) {
					alert("Ac√°... 2!!!");
					titulomodalflash.innerText="TRAZAR RUTA";
					cuerpomodalflash.innerHTML = '<span style="color:green"><br><b>¬øNecesit√°s ayuda para llegar?.</b><br><br><span style="color:black">Puedo trazarte una ruta '+
					'a partir de tu ubicaci√≥n actual y brindarte algunas indicaciones.-<br></span>';
					btnindicacionesmodalflash.style.display='flex';
					btncerrarmodalflash.style.display='flex';
					btncerrarmodalflash.innerHTML = "No";
					tiempomodalflash=5000;
					ModalFlash(tiempomodalflash);
				};
				if (distancia<=1100 && distancia>10) {
					alert("Ac√°... 3!!!");
					titulomodalflash.innerText="TRAZAR RUTA";
					cuerpomodalflash.innerHTML = '<span style="color:green"><br><b>¬øNecesit√°s ayuda para llegar?.</b><br><br><span style="color:black">Puedo mostrarte en tiempo real por d√≥nde vas '+
					'y el destino con vista de ambos puntos en el mapa.-<br></span>';
					btnindicacionesmodalflash.style.display='flex';
					btncerrarmodalflash.style.display='flex';
					btncerrarmodalflash.innerHTML = "No";
					tiempomodalflash=5000;
					ModalFlash(tiempomodalflash);
				};
			};
			if (orientarme=="si") {
				if (distancia<=1100) {
					botondetallesruta.style.display="none";
					panelrutas.style.display="none";
					if (ruta) {
						ruta.remove();
					};
				};
				if (distancia>1100) {
					botondetallesruta.style.display="block";
				};
			};
			if (distancia > 10) {
				if (distancia>6000) {msg="¬°Est√°s a unos "+(Math.round(distancia/1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, "."))+" kil√≥metros del destino!"};
				if (distancia<6001) {msg="¬°Est√°s a unos "+(Math.round(distancia).toString().replace(/\B(?=(\d{3})+(?!\d))/g, "."))+" metros del destino!"};
			};
			if (!dentro) { //|| aer || lugar) {
				cajadistancia.textContent = msg+" (En l√≠nea recta).-";
				cajadistancia.style.background = "#d4edda";
				cajadistancia.style.color = "#155724"
			} else {
				if (dispositivo=="movil") {cajadistancia.innerHTML = "Est√°s dentro del territorio de la congegaci√≥n.<br>La velocidad m√°xima recomendada para circular aqui es de 30 km/h.-"};
				if (dispositivo=="pc") {cajadistancia.innerHTML = "Est√°s dentro del territorio de la congregaci√≥n.-"};
				cajadistancia.style.background = "#d4edda";
				cajadistancia.style.color = "#155724";
				botondetallesruta.style.display="none";
			};
			if (distancia>180) {avisollegada="si"};
			if (distancia >80 && distancia <= 180 && dispositivo=="movil") {
				msg="Avanza despacio y con atenci√≥n. ¬°Est√°s a pocos metros del destino!.";
				if (avisollegada=="si") {AlertaLlegada(msg)};
			};
			if (distancia>10 && distancia<80) {avisollegada="si"};
			if (distancia <= 10 && dispositivo=="movil") {
				cajadistancia.textContent = "¬°Has llegado a tu destino!.-";
				refrescoRutaActivo = false;
				clearInterval(intervaloRuta);
				intervaloRuta = null;
				setTimeout(() => {
					cajadistancia.classList.remove("visible");
				}, 10000);
				mapa.setView(coordenadas_ubicacion_real, 19);
				if (avisollegada=="si") {AlertaLlegada("Has llegado a tu destino "+msgencontrado)};
			};
		};

		// Evento en caso de error
		function ErrorGPS(e) {
			cajadistancia.classList.add("visible");
			cajadistancia.textContent = "No se pudo obtener la ubicaci√≥n: " + e.message;
			cajadistancia.style.background = "white";
			cajadistancia.style.color = "red";
			botondetallesruta.style.display='none';
		};
		
		//Anuncio en voz alta de cercan√≠a/llegada a destino
		function AlertaLlegada(msg) {
			const utterance = new SpeechSynthesisUtterance(msg);
			speechSynthesis.speak(utterance);
			if (distancia>10) {avisollegada="no"};
			if (distancia<=10) {avisollegada="no";DetenerActualizarUbicacion()};
			clearTimeout(temporizadormodalflash);
		};
		
		function DistanciaEnTiempoReal() {
			if (cartografiar==="salida") {
				const destino=L.latLng(puntomascercano[0], puntomascercano[1]);
				const minDistance=coordenadas_ubicacion_real.distanceTo(destino);
				return minDistance;
			};
			if (cartografiar==="casa") {
				const minDistance=coordenadas_ubicacion_real.distanceTo(puntomascercano);
				return minDistance;
			};
			const point = turf.point([coordenadas_ubicacion_real.lng, coordenadas_ubicacion_real.lat]);
			if (cartografiar==="congregacion" || cartografiar==="territorio") {
				const lineSegments = [];
				if (cartografiar==="territorio") {var coords = poligono.features[0].geometry.coordinates[0][0]};
				if (cartografiar==="congregacion") {var coords = perimetro.features[0].geometry.coordinates[0][0]};
				for (let i = 0; i < coords.length - 1; i++) {
					lineSegments.push(turf.lineString([coords[i], coords[i + 1]]));
				};
				let minDistance = Infinity;
				let nearestPoint = null;
				let nearestSegment = null;
				lineSegments.forEach(segment => {
					const snapped = turf.nearestPointOnLine(segment, point);
					const dist = turf.distance(point, snapped, {units: 'meters'});
					if (dist < minDistance) {
						minDistance = dist;
						nearestPoint = snapped;
						nearestSegment = segment;
					};
				});
				puntomascercano= [nearestPoint.geometry.coordinates[1], nearestPoint.geometry.coordinates[0]];
				return minDistance;
			};
		};
		
		function ChequearPredio(coords) {
			const pt = turf.point([coords.lng, coords.lat]);
			let found = null;
			for (const f of perimetro.features) {
				if (["Polygon", "MultiPolygon"].includes(f.geometry.type)) {
					if (turf.booleanPointInPolygon(pt, f)) {
						found = f;
						break;
					}
				}
			}
			return found;
		};
		
		// Funci√≥n para detener geolocalizaci√≥n
		function DetenerActualizarUbicacion() {
			clearInterval(intervalo);
			clearInterval(intervaloRuta);
			clearTimeout(temporizadormodalflash);
			clearTimeout(tiempo);
			actualizarruta="si";
			if (ruta) {ruta.remove()};
			botondetallesruta.style.display='none';
			coordenadas_ubicacion_real="";
			distancia="";
			mapa.stopLocate();
			mapa.off('locationfound', ActualizarUbicacion);
			mapa.off('locationerror', ErrorGPS);
			if (marca_ubicacion_real) {
				marca_ubicacion_real.remove();
				coordenadas_ubicacion_real = "";
				marca_ubicacion_real = "";
			};
			titulomodalflash.innerText="SEGUIMIENTO DETENIDO";
			cuerpomodalflash.innerHTML = '<span style="display: block; text-align: center; width: 100%; color:green;"><br><b>Servicio de seguimiento en tiempo real detenido.</b><br><br><span style="color:black">'+
			'No podr√°s visualizar tu posici√≥n ni recibir indicaciones para llegar a un lugar.'+
			'<br><br>Podr√°s volver a activarla en el momento que lo desees.</span>';
			tiempomodalflash=5000;
			//btncerrarmodalflash.textContent === "Cerrar";
			ModalFlash(tiempomodalflash);
		};

		<!--Funci√≥n para Centrar en Mi Ubicaci√≥n Actual-->
		function CentrarMiUbicacion() {
			barralateral.close();
			mapa.setView(coordenadas_ubicacion_real, 17);
		};
		
		<!--Funci√≥n para Centrar dentro del Territorio-->
		function CentrarEnTerritorio() {
			barralateral.close();
			mapa.flyTo([-32.9280586817747, -68.77360525273423], 15);
		};

		<!--Funci√≥n para detener el seguimiento en tiempo real-->
		function desactivar_seguimiento() {
			botondetallesruta.style.display='none';
			barralateral.close();
			seguimiento="";
			orientarme="";
			//avisollegada="";
			//dentropredio="";
			//document.getElementById("vermiubicacion").style.visibility='hidden';
			//document.getElementById("gps").src="./images/slide_off.jpg";
			//document.getElementById("miubicacion").style.visibility='hidden';
			//document.getElementById("gpson").style.visibility='hidden';
			//document.getElementById("gpsoff").style.visibility='visible';
			//document.getElementById("botoncentrado").style.visibility='hidden';
			//document.getElementById("activargps").style.visibility='visible';
			//cajadistancia.classList.remove("visible");
			//document.getElementById("dondestoy").style.visibility='hidden';
			//document.getElementById("ubicacion_estado").href="javascript:activar_seguimiento()";
			//DetenerActualizarUbicacion();
			//if (marca_ubicacion_real) {mapa.removeLayer(marca_ubicacion_real)};
			//marca_ubicacion_real="";
			//coordenadas_ubicacion_real="";
			//if (ruta) {ruta.remove()};
			botoncentrado.style.display='none';
			cajadistancia.classList.remove("visible");
			//document.getElementById("dondestoy").style.visibility='hidden';
			document.getElementById("ubicacion_estado").href="javascript:activar_seguimiento(seguimiento)";
			clearInterval(intervalo);
			clearInterval(intervaloRuta);
			clearTimeout(temporizadormodalflash);
			clearTimeout(tiempo);
			if (ruta) {ruta.remove()};
			botondetallesruta.style.display='none';
			coordenadas_ubicacion_real="";
			distancia="";
			mapa.stopLocate();
			if (marca_ubicacion_real) {
				marca_ubicacion_real.remove();
				coordenadas_ubicacion_real = "";
				marca_ubicacion_real = "";
			};
			titulomodalflash.innerText="SEGUIMIENTO DETENIDO";
			cuerpomodalflash.innerHTML = '<span style="display: block; text-align: center; width: 100%; color:green;"><br><b>Servicio de seguimiento en tiempo real detenido.</b><br><br><span style="color:black">'+
			'No podr√°s visualizar tu posici√≥n ni recibir indicaciones para llegar a un lugar.'+
			'<br><br>Podr√°s volver a activarla en el momento que lo desees.</span>';
			btncerrarmodalflash.textContent = "Cerrar";
			tiempomodalflash=5000;
			ModalFlash(tiempomodalflash);
			if (ruta) {ruta.remove()};
			if (marcapuntosalida) {marcapuntosalida.remove()};
			mapa.flyTo([-32.9280586817747, -68.77360525273423],15);
		};
		
		function RefrescarRuta() {
			if (!refrescoRutaActivo) return;
			TrazarRuta();
			setTimeout(RefrescarRuta, 180000); // 3 minutos
		};

		function IniciarRuteo() {
			if (refrescoRutaActivo) return;
			refrescoRutaActivo = true;
			RefrescarRuta(); // arranca
		};

		<!--Funci√≥n para Trazar Ruta Sugerida con OSRM-->
		function TrazarRuta() {
			clearTimeout(temporizadormodalflash);
			clearTimeout(tiempo);
			modalinicial.close();
			mimodalflash.style.display='none';
			btnindicacionesmodalflash.style.display='none';
			//visitas.style.display='none';
			document.getElementById("borrableinicial").style.display='none';
			botoncentrado.style.display="block";
			VerificarConexion();
			if (conexion==="si") {VerificarGPS()};
			distancia=DistanciaEnTiempoReal();
			avisollegada="si";
			//if (ruta) {ruta.remove()};
			//document.getElementById("btn-indicaciones-modal-flash").style.visibility='hidden';
			//document.getElementById("MiModalFlash").style.visibility='hidden';
			
			
			
			
			// üö∂ Cerca del destino ‚Üí NO rutea, pero NO mata el intervalo
			if (distancia <= 1100) {
				ActualizarUbicacion();
				return;
			}
			// üî• eliminar ruta anterior
			if (ruta) {
				mapa.removeControl(ruta);
				ruta = null;
			}
			// üî• crear nueva ruta
			ruta = L.Routing.control({
				waypoints: [
					L.latLng(coordenadas_ubicacion_real.lat, coordenadas_ubicacion_real.lng),
					L.latLng(puntomascercano.lat, puntomascercano.lng)
				],
				router: L.Routing.osrmv1({
					serviceUrl: 'https://router.project-osrm.org/route/v1',
					language: 'es'
				}),
				showAlternatives: true,
				draggableWaypoints: false,
				createMarker: () => null,
				lineOptions: {
					styles: [{ color: 'red', weight: 9, opacity: 0.9 }]},
				altLineOptions: {styles: [{color: 'blue', weight: 6, opacity: 0.6, dashArray: '8,12'}]} 
			}).addTo(mapa);
			
			
			//Probando desde ac√°......
			function segundosAHorasMinutos(segundos) {
				const horas = Math.floor(segundos / 3600);
				const minutos = Math.round((segundos % 3600) / 60);
				if (horas > 0) {
					return `${horas} h ${minutos} min`;
				}
				return `${minutos} min`;
			};
			
			ruta.on('routesfound', function (e) {
				panelrutas.innerHTML = '';
				e.routes.forEach((route, index) => {
					const distanciaKm = (route.summary.totalDistance / 1000).toFixed(2);
					const tiempoFormateado = segundosAHorasMinutos(route.summary.totalTime);
					const div = document.createElement('div');
					div.style.padding = '8px';
					div.style.borderBottom = '1px solid #ccc';
					div.innerHTML = `
						<strong>Ruta ${index === 0 ? 'principal' : 'alternativa ' + index}</strong><br>
						üìè Distancia: ${distanciaKm} km<br>
						‚è±Ô∏è Tiempo estimado: ${tiempoFormateado}
					`;
					panelrutas.appendChild(div);
				});
			});
			//Hasta ac√°.-
		
		
		botondetallesruta.style.display = "block";
		panelrutas.style.display = "block";
		panelrutas.replaceChildren(ruta.getContainer());
			
			};
			
			
			
			//distancia=DistanciaEnTiempoReal();
			//dentro = ChequearPredio(coordenadas_ubicacion_real);//{lat:"-32.92738990461459", lng:"-68.77720752661189"});//coordenadas_ubicacion_real);
			<!-- if (!dentro || dentro==null) { -->
				<!-- dentropredio=""} else {dentropredio="si"}; -->
			<!-- //if (dentropredio=="si") {alert("Est√°s dentro del teritorio")}; -->
			<!-- if (orientarme=="si" && (dentropredio=="" || capa_territoriofiltrado)) {cajadistancia.style.visibility="visible"}; -->
			<!-- if (distancia>6000) {msg="¬°Est√°s a unos "+(Math.round(distancia/1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, "."))+" kil√≥metros del destino! (En l√≠nea recta).-"}; -->
			<!-- if (distancia<6001) {msg="¬°Est√°s a unos "+(Math.round(distancia).toString().replace(/\B(?=(\d{3})+(?!\d))/g, "."))+" metros del destino! (En l√≠nea recta).-"}; -->
			<!-- cajadistancia.textContent = msg; -->
			<!-- cajadistancia.style.background = "#d4edda"; -->
			<!-- cajadistancia.style.color = "#155724"; -->
			<!-- if (distancia<=2200 && lugar) { -->
				<!-- if (ruta) {ruta.remove()}; -->
				<!-- clearInterval(actualizarruta); -->
				<!-- ActualizarUbicacion(); -->
			<!-- }; -->
			<!-- if (distancia>2200) { -->
				<!-- ruta=L.Routing.control({ -->
					<!-- waypoints: [coordenadas_ubicacion_real, puntomascercano], -->
					<!-- router: L.Routing.osrmv1({ -->
						<!-- serviceUrl: 'https://router.project-osrm.org/route/v1', -->
						<!-- language: 'es', -->
					<!-- }), -->
					<!-- showAlternatives: true, -->
					<!-- routeWhileDragging: true, -->
					<!-- draggableWaypoints: false, -->
					<!-- collapsible: true, -->
					<!-- waypointMode: 'snap', -->
					<!-- lineOptions: {styles: [{color: 'red', opacity: 0.6, weight: 6}]}, -->
					<!-- altLineOptions: {styles: [{color: 'blue', opacity: 0.5, weight: 4}]}, -->
					<!-- createMarker: function(i, wp) { -->
						<!-- return L.marker(wp.latLng, { -->
							<!-- draggable: false, -->
							<!-- icon: L.icon({ -->
								<!-- iconUrl: './images/posicion.png', -->
								<!-- iconSize: [0, 0] -->
							<!-- }) -->
						<!-- }); -->
					<!-- } -->
				<!-- }).addTo(mapa); -->
				<!-- botondetallesruta.style.display = "block"; -->
				<!-- panelrutas.style.display = "block"; -->
				<!-- panelrutas.replaceChildren(ruta.getContainer()); -->
				<!-- //Centrar el mapa para que se vean ubicaci√≥n en tiempo real y EEA √≥ Sector/Persona buscado **SOLO la primera vez** -->
				<!-- if (actualizarruta=="si") {const centrar = L.latLngBounds(coordenadas_ubicacion_real, puntomascercano);mapa.fitBounds(centrar, {padding: [50, 50]});}; -->
				<!-- //const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${coordenadas_ubicacion_real.lng},${coordenadas_ubicacion_real.lat};${puntomascercano.lng},${puntomascercano.lat}?overview=full&geometries=geojson`; -->
				<!-- //Solicito la ruta y la dibujo con animaci√≥n -->
				<!-- //fetch(osrmUrl) -->
				<!-- //	.then(response => response.json()) -->
				<!-- //	.then(data => { -->
				<!-- //		if (data.routes && data.routes.length > 0) { -->
				<!-- //			const route = data.routes[0].geometry; -->
				<!-- //			// Convertimos las coordenadas de GeoJSON a un formato que Leaflet entienda -->
				<!-- //			const latlngs = route.coordinates.map(coord => [coord[1], coord[0]]); -->
				<!-- //		}; -->
				<!-- //	}) -->
				<!-- //	.catch(error => { -->
				<!-- //		titulomodalflash.innerText="PROBLEMAS PARA SUGERIR UNA RUTA"; -->
				<!-- //		cuerpomodalflash.innerHTML = '<span style="color:red"><br><b>El servidor de OSRM no puede sugerirte una ruta en este momento.-</span>'; -->
				<!-- //		tiempomodalflash=5000; -->
				<!-- //		ModalFlash(tiempomodalflash); -->
				<!-- //	}); -->
					
				<!-- actualizarruta=setInterval(()=>{ -->
					<!-- if (ruta) {ruta.remove()}; -->
					<!-- ruta=L.Routing.control({ -->
					<!-- waypoints: [coordenadas_ubicacion_real, puntomascercano], -->
					<!-- router: L.Routing.osrmv1({ -->
						<!-- serviceUrl: 'https://router.project-osrm.org/route/v1', -->
						<!-- language: 'es', -->
					<!-- }), -->
					<!-- showAlternatives: true, -->
					<!-- routeWhileDragging: true, -->
					<!-- draggableWaypoints: false, -->
					<!-- collapsible: true, -->
					<!-- waypointMode: 'snap', -->
					<!-- lineOptions: {styles: [{color: 'red', opacity: 0.6, weight: 6}]}, -->
					<!-- altLineOptions: {styles: [{color: 'blue', opacity: 0.5, weight: 4}]}, -->
					<!-- createMarker: function(i, wp) { -->
						<!-- return L.marker(wp.latLng, { -->
							<!-- draggable: false, -->
							<!-- icon: L.icon({ -->
								<!-- iconUrl: './images/posicion.png', -->
								<!-- iconSize: [0, 0] -->
							<!-- }) -->
						<!-- }); -->
					<!-- } -->
					<!-- }).addTo(mapa); -->
					<!-- //const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${coordenadas_ubicacion_real.lng},${coordenadas_ubicacion_real.lat};${puntomascercano.lng},${puntomascercano.lat}?overview=full&geometries=geojson`; -->
					<!-- //Solicito la ruta y la dibujo con animaci√≥n -->
					<!-- //fetch(osrmUrl) -->
					<!-- //	.then(response => response.json()) -->
					<!-- //	.then(data => { -->
					<!-- //		if (data.routes && data.routes.length > 0) { -->
					<!-- //			const route = data.routes[0].geometry; -->
					<!-- //			// Convertimos las coordenadas de GeoJSON a un formato que Leaflet entienda -->
					<!-- //			const latlngs = route.coordinates.map(coord => [coord[1], coord[0]]); -->
					<!-- //		}; -->
					<!-- //	}) -->
					<!-- //	.catch(error => { -->
					<!-- //		titulomodalflash.innerText="PROBLEMAS PARA SUGERIR UNA RUTA"; -->
					<!-- //		cuerpomodalflash.innerHTML = '<span style="color:red"><br><b>El servidor de OSRM no puede sugerirte una ruta en este momento.-</span>'; -->
					<!-- //		tiempomodalflash=5000; -->
					<!-- //		ModalFlash(tiempomodalflash); -->
					<!-- //	}); -->
				<!-- },300000); -->
			<!-- }; -->
		//};
	
		//Bloque Modal Flash
		function ModalFlash(tiempo) {
			//document.getElementById("MiModalFlash").style.visibility='visible';
			mimodalflash.style.display='block';
			//let intervalo;
			let timeout;
			let restante = tiempo/1000;
			document.getElementById('contador').textContent = restante;
			intervalo = setInterval(() => {
				restante--;
				document.getElementById('contador').textContent = restante;
				if (restante <= 0) clearInterval(intervalo);
				}, 1000);
			temporizadormodalflash=setTimeout(() => {
				btnindicacionesmodalflash.style.display='none';
				mimodalflash.style.display='none';
				clearTimeout(temporizadormodalflash);
				//document.getElementById("modal-inicial").close();
				//modalinicial.close();
				if (nomostrarinicial.checked) {localStorage.setItem('MOSTRAR_INICIAL', Version);document.getElementById("borrableinicial").style.display="none"};
				//if (mail=="si") {EnviarMail()};
			}, tiempo);
		};
		
		document.getElementById("casas_hnos").style.display='none';
		document.getElementById("ayuda_usuario").style.display='none';
		document.getElementById("log_si").style.display='none';
		document.getElementById("ocultarflias").style.display="none";
		//document.getElementById("localizacion").style.display='none';
		
		if (conexion=="no") {
			document.getElementById("Conectividad").style.display="inline";
		} else {
			document.getElementById("Conectividad").style.display="none";
		};

		if (! navigator.userAgent.match(/Windows/i) && localStorage.getItem('MOSTRAR_CELULAR') !=="no") {
			//document.getElementById("modal_inicial").showModal()
			modalinicial.showModal();
		} else {
			if (conexion=="no") {document.getElementById("Conectividad").style.display="inline"; document.getElementById("Apaisado").style.display="none";modalinicial.showModal()};//document.getElementById("modal_inicial").showModal();}
		};
		
		btncerrarmodalflash.addEventListener("click",()=>{
			btnindicacionesmodalflash.style.display='none';
			mimodalflash.style.display='none';
			modalinicial.close();
			clearInterval(intervalo);
			clearInterval(intervaloRuta);
			clearTimeout(temporizadormodalflash);
			clearTimeout(tiempo);
			if (ruta) {ruta.remove();botondetallesruta.style.display="none"};
			if (nomostrarinicial.checked) {
				try {
					localStorage.setItem('MOSTRAR_INICIAL', Version);
					document.getElementById("borrableinicial").style.display="none";
				} catch(e){
					// ignore storage errors
					console.warn('No se pudo guardar preferencia en localStorage', e);
				}
			};
			if (btncerrarmodalflash.textContent.trim() === "No") {orientarme = "no"};
			avisollegada="no";
			clearTimeout(temporizadormodalflash);
			tiempomodalflash=5000;
		});
		
		btnindicacionesmodalflash.addEventListener("click",()=>{
			clearTimeout(temporizadormodalflash);
			orientarme="si";
			avisollegada="si";
			if (distancia>6000) {msg="¬°Est√°s a unos "+(Math.round(distancia/1000).toString().replace(/\B(?=(\d{3})+(?!\d))/g, "."))+" kil√≥metros del destino!"};
			if (distancia<6001) {msg="¬°Est√°s a unos "+(Math.round(distancia).toString().replace(/\B(?=(\d{3})+(?!\d))/g, "."))+" metros del destino!"};
			if (distancia<1100 && ruta) {ruta.remove();botondetallesruta.style.display='none'};
			cajadistancia.classList.add("visible");
			cajadistancia.textContent = msg+" (En l√≠nea recta).-";
			clearInterval(intervalo);
			clearInterval(intervaloRuta);
			clearTimeout(tiempo);
			if (dispositivo=="movil") {
				titulomodalflash.innerText="TRAZAR RUTA";
				cuerpomodalflash.innerHTML = '<span style="color:green"><br><b>Se te ofrecer√°n alertas por voz.</b><br><br><span style="color:black">Por lo tanto, asegurate de tener activado el sonido del dispositivo y a un volumen que puedas escucharlo sin distraerte demasiado.-<br></span>';
				btnindicacionesmodalflash.style.display='none';
				btncerrarmodalflash.textContent = "Cerrar";
				tiempomodalflash=5000;
				ModalFlash(tiempomodalflash);
			};
		});
		
		btncerrarmodalinicial.addEventListener("click",()=>{
			if (nomostrarcelular.checked) {
				try {
					localStorage.setItem('MOSTRAR_CELULAR', 'no');
					document.getElementById("borrablecelular").style.display="none";//visibility="hidden";
				} catch(e){
					// ignore storage errors
					console.warn('No se pudo guardar preferencia en localStorage', e);
				}
			};
			modalinicial.close()
		});
		
		nomostrarinicial.addEventListener("click",()=>{
			btnindicacionesmodalflash.style.display='none';
			mimodalflash.style.display='none';
			//document.getElementById("modalinicial").close();
			modalinicial.close();
			if (nomostrarinicial.checked) {
				try {
					localStorage.setItem('MOSTRAR_INICIAL', Version);
					document.getElementById("borrableinicial").style.display="none";
				} catch(e){
					// ignore storage errors
					console.warn('No se pudo guardar preferencia en localStorage', e);
				}
			};
			orientarme="no";
			avisollegada="no";
			clearTimeout(temporizadormodalflash);
			tiempomodalflash=5000;
		});
		
		nomostrarcelular.addEventListener("click",()=>{
			if (nomostrarcelular.checked) {
				try {
					localStorage.setItem('MOSTRAR_CELULAR', 'no');
					document.getElementById("borrablecelular").style.display="none";//visibility="hidden";
				} catch(e){
					// ignore storage errors
					console.warn('No se pudo guardar preferencia en localStorage', e);
				}
			};
			modalinicial.close()
		});
		
		nomostrarlonuevo.addEventListener("click",()=>{
			cartelnuevo.classList.remove('show');
			// despu√©s de la transici√≥n, ocultamos
			setTimeout(()=> cartelnuevo.style.display = 'none', 160);
			document.getElementById("flecharoja").style.visibility='hidden';
			if (nomostrarlonuevo.checked) {
				try {
					localStorage.setItem('MOSTRAR_NUEVO', Version);
					elementonovedoso.classList.remove('resaltarlonovedoso');
				} catch(e){
					// ignore storage errors
					console.warn('No se pudo guardar preferencia en localStorage', e);
				}
			}
		});
		
		// === BOT√ìN MOSTRAR / OCULTAR DETALLES RUTAS===
		let abierto = true;
		botondetallesruta.onclick = () => {
			abierto = !abierto;
			panelrutas.style.display = abierto ? "block" : "none";
			botondetallesruta.textContent = abierto ? "Detalles Ruta ‚ñæ" : "Detalles Ruta ‚ñ∏";
			mapa.invalidateSize();
		};
		
		//Bloque para el Calendario
		//const borrarfecha = document.getElementById('BorrarFecha');
		const titulocalendario = document.getElementById('TituloCalendario');
		const diasdelasemanaEl = document.getElementById('diasdelasemana');
		const diasEl = document.getElementById('dias');

		let fechaISO = null; // Fecha seleccionada en formato ISO (YYYY-MM-DD)

		// Utilidades de fecha
		const hoydia = new Date();
		const anio = hoydia.getFullYear();
		const mes = hoydia.getMonth(); // 0-11

		const nombresmeses = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
		const nombresdiasdelasemana = ['L','M','X','J','V','S','D'];

		// ==== 3) Construir cabecera y semana ====
		function ArmarSemanas(){
			diasdelasemanaEl.innerHTML = '';
			nombresdiasdelasemana.forEach(w => {
				const el = document.createElement('div');
				el.className = 'calendario-semana';
				el.textContent = w;
				diasdelasemanaEl.appendChild(el);
			});
		};

		function pad(n){ return String(n).padStart(2,'0'); }
		function formatoISO(y,m,d){ return `${y}-${pad(m+1)}-${pad(d)}`; }
		function formatoHumano(d,m,y){ return `${pad(d)}/${pad(m+1)}/${y}`; }

		// ==== 4) Construir el calendario SOLO del mes actual ====
		function ArmarCalendario(){
			let fechia = new Date();
			let opciones = { month: 'long' };
			let anioi = fechia.getFullYear();
			let mesi = fechia.toLocaleDateString('es-ES', opciones);
			let nombremes=mesi.charAt(0).toUpperCase() + mesi.slice(1);
			titulocalendario.textContent = nombremes+" "+anioi;
			mes_anio= `${nombresmeses[mes]} ${anio}`;
			diasEl.innerHTML = '';

			// Primer d√≠a del mes (ajustado para que la semana empiece Lunes)
			const first = new Date(anio, mes, 1);
			const firstWeekday = (first.getDay() + 6) % 7; // 0=Lunes ... 6=Domingo

			const last = new Date(anio, mes + 1, 0);
			const totalDays = last.getDate();

			// Relleno vac√≠o antes del 1
			for (let i=0; i<firstWeekday; i++){
				const empty = document.createElement('div');
				empty.className = 'calendario-dia';
				empty.setAttribute('aria-disabled','true');
				empty.textContent = '';
				diasEl.appendChild(empty);
			}

			// D√≠as del mes
			for (let d=1; d<=totalDays; d++){
				const btn = document.createElement('button');
				btn.type = 'button';
				btn.className = 'calendario-dia';
				btn.textContent = d;
				const hoy = (d === hoydia.getDate());
				if (hoy) btn.classList.add('hoydia');
				const iso = formatoISO(d, mes, anio);
				btn.dataset.iso = iso;
				btn.title = `Seleccionar ${formatoHumano(d, mes, anio)}`;
				btn.addEventListener('click', () => {
					// Quitar selecci√≥n previa
					diasEl.querySelectorAll('.calendario-dia.selected').forEach(el=>el.classList.remove('selected'));
					btn.classList.add('selected');
					fechaISO = iso;
					const ev = new CustomEvent('fecha-seleccionada', { detail: { iso, day: d, month: mes+1, anio} });
					window.dispatchEvent(ev);
				});
				diasEl.appendChild(btn);
			};
		};

		// ==== 5) Abrir/Cerrar modal ====
		function AbrirModalCalendario(id) {
			barralateral.close();
			//document.getElementById("BorrarFecha").style.display="none";
			document.getElementById("ModalCalendario").classList.add("active");
			document.getElementById(id).style.display = "block";
			document.getElementById("botonnorte").style.display="none";
			//document.getElementById("botonsalidas").style.display="none";
			//document.getElementById("botonrecargar").style.display="none";
		};
		
		function CerrarModalCalendario(id) {
			document.getElementById(id).style.display = "none";
			// si no queda ning√∫n modal abierto, cerramos overlay
			const modal1Visible = document.getElementById("modal1").style.display === "block";
			const modal2Visible = document.getElementById("modal2").style.display === "block";
			if (!modal1Visible && !modal2Visible) {
				document.getElementById("ModalCalendario").classList.remove("active");
				document.getElementById("botonnorte").style.display="inline";
				//document.getElementById("botonsalidas").style.display="inline";
				//document.getElementById("botonrecargar").style.display="inline";
			};
		};

		//borrarfecha.addEventListener('click', () => {
		//	fechaISO = null;
		//	diasEl.querySelectorAll('.calendario-dia.selected').forEach(el=>el.classList.remove('selected'));
		//});

		// ==== 6) Inicializar calendario ====
		ArmarSemanas();
		ArmarCalendario();
		ArmarListaTerritorios();

		// ==== 7) Demostraci√≥n de captura: escuchar el evento y hacer algo en el mapa ====
		window.addEventListener('fecha-seleccionada', (e) => {
			const { iso } = e.detail;
			document.getElementById('modal2').style.display = "block";
			BuscarSalida(e.detail["day"],e.detail["month"],e.detail["anio"]);
			CerrarModalCalendario('modal1');
		});
		
		function BuscarSalida(dia,mes,anio) {
			document.getElementById("modal2").classList.add("active");
			const encontrados = salidas.filter(item => item.Dia === (Number(dia)) && item.Mes===(Number(mes)) && item.Anio===(Number(anio)));
			detallessalidas="";
			detallessalidasm="";
			detallessalidast="";
			detallessalidasn="";
			presencial="no";
			vueltam=0;
			vueltat=0;
			vueltan=0;
			if (encontrados.length > 0) {
				encontrados.forEach((objeto, i) => {
					// Recorremos las claves y valores
					for (let clave in objeto) {
						if (clave==="DiaSemana") {fecha="Salidas para el d√≠a "+(objeto[clave]);fechita="Salida para el d√≠a "+(objeto[clave])};
						if (clave==="Dia") {fecha=fecha+" "+(objeto[clave])+"/";fechita=fechita+" "+(objeto[clave])+"/"};
						if (clave==="Mes") {fecha=fecha+(objeto[clave])+"/";fechita=fechita+(objeto[clave])+"/"};
						if (clave==="Anio") {fecha=fecha+(objeto[clave]);fechita=fechita+(objeto[clave])};
						if (clave==="HoraM" && objeto[clave] !=="") {
							vueltam=vueltam+1;
							if (vueltam===1) {
								salidam1=objeto["PuntoEncuentroM"];
								territoriom1=objeto["TerritorioM"];
								tiposalidam1=objeto["SalidaM"];
								horam1=objeto[clave];
								if (salidam1==="Zoom") {detallessalidasm=detallessalidasm+"La salida por la ma√±ana ser√° a las "+objeto[clave]+" "+objeto["SalidaM"]+" por "+salidam1+". Conductor: "+objeto["ConductorM"]+". Territorio: "+objeto["TerritorioM"]+"."}
								else {presencial="si";detallessalidasm=detallessalidasm+"La salida por la ma√±ana ser√° a las "+objeto[clave]+" "+objeto["SalidaM"]+" desde <a href='#' onclick='PuntoEncuentro(salidam1,territoriom1,fechita,horam1,tiposalidam1)'>"+salidam1+"</a>. Conductor: "+objeto["ConductorM"]+". Territorio: "+objeto["TerritorioM"]+"."};
							};
							if (vueltam===2) {
								salidam2=objeto["PuntoEncuentroM"];
								territoriom2=objeto["TerritorioM"];
								tiposalidam2=objeto["SalidaM"];
								horam2=objeto[clave];
								if (salidam2==="Zoom") {detallessalidasm=detallessalidasm+"<br>La salida por la ma√±ana ser√° a las "+objeto[clave]+" "+objeto["SalidaM"]+" por "+salidam2+". Conductor: "+objeto["ConductorM"]+". Territorio: "+objeto["TerritorioM"]+"."}
								else {presencial="si";detallessalidasm=detallessalidasm+"<br>La salida por la ma√±ana ser√° a las "+objeto[clave]+" "+objeto["SalidaM"]+" desde <a href='#' onclick='PuntoEncuentro(salidam2,territoriom2,fechita,horam2,tiposalidam2)'>"+salidam2+"</a>. Conductor: "+objeto["ConductorM"]+". Territorio: "+objeto["TerritorioM"]+"."};
							};
							if (vueltam===3) {
								salidam3=objeto["PuntoEncuentroM"];
								territoriom3=objeto["TerritorioM"];
								tiposalidam3=objeto["SalidaM"];
								horam3=objeto[clave];
								if (salidam3==="Zoom") {detallessalidasm=detallessalidasm+"<br>La salida por la ma√±ana ser√° a las "+objeto[clave]+" "+objeto["SalidaM"]+" por "+salidam3+". Conductor: "+objeto["ConductorM"]+". Territorio: "+objeto["TerritorioM"]+"."}
								else {presencial="si";detallessalidasm=detallessalidasm+"<br>La salida por la ma√±ana ser√° a las "+objeto[clave]+" "+objeto["SalidaM"]+" desde <a href='#' onclick='PuntoEncuentro(salidam3,territoriom3,fechita,horam3,tiposalidam3)'>"+salidam3+"</a>. Conductor: "+objeto["ConductorM"]+". Territorio: "+objeto["TerritorioM"]+"."};
							};
							if (vueltam===4) {
								salidam4=objeto["PuntoEncuentroM"];
								territoriom4=objeto["TerritorioM"];
								tiposalidam4=objeto["SalidaM"];
								horam4=objeto[clave];
								if (salidam4==="Zoom") {detallessalidasm=detallessalidasm+"<br>La salida por la ma√±ana ser√° a las "+objeto[clave]+" "+objeto["SalidaM"]+" por "+salidam4+". Conductor: "+objeto["ConductorM"]+". Territorio: "+objeto["TerritorioM"]+"."}
								else {presencial="si";detallessalidasm=detallessalidasm+"<br>La salida por la ma√±ana ser√° a las "+objeto[clave]+" "+objeto["SalidaM"]+" desde <a href='#' onclick='PuntoEncuentro(salidam4,territoriom4,fechita,horam4,tiposalidam4)'>"+salidam4+"</a>. Conductor: "+objeto["ConductorM"]+". Territorio: "+objeto["TerritorioM"]+"."};
							};
							if (vueltam===5) {
								salidam5=objeto["PuntoEncuentroM"];
								territoriom5=objeto["TerritorioM"];
								tiposalidam5=objeto["SalidaM"];
								horam5=objeto[clave];
								if (salidam5==="Zoom") {detallessalidasm=detallessalidasm+"<br>La salida por la ma√±ana ser√° a las "+objeto[clave]+" "+objeto["SalidaM"]+" por "+salidam5+". Conductor: "+objeto["ConductorM"]+". Territorio: "+objeto["TerritorioM"]+"."}
								else {presencial="si";detallessalidasm=detallessalidasm+"<br>La salida por la ma√±ana ser√° a las "+objeto[clave]+" "+objeto["SalidaM"]+" desde <a href='#' onclick='PuntoEncuentro(salidam5,territoriom5,fechita,horam5,tiposalidam5)'>"+salidam5+"</a>. Conductor: "+objeto["ConductorM"]+". Territorio: "+objeto["TerritorioM"]+"."};
							};
						};
						if (clave==="HoraT" && objeto[clave] !=="") {
							vueltat=vueltat+1;
							if (vueltat===1) {
								salidat1=objeto["PuntoEncuentroT"];
								territoriot1=objeto["TerritorioT"];
								tiposalidat1=objeto["SalidaT"];
								horat1=objeto[clave];
								if (salidat1==="Zoom") {detallessalidast=detallessalidast+"La salida por la tarde ser√° a las "+objeto[clave]+" "+objeto["SalidaT"]+" por "+salidat1+". Conductor: "+objeto["ConductorT"]+". Territorio: "+objeto["TerritorioT"]+"."}
								else {presencial="si";detallessalidast=detallessalidast+"La salida por la tarde ser√° a las "+objeto[clave]+" "+objeto["SalidaT"]+" desde <a href='#' onclick='PuntoEncuentro(salidat1,territoriot1,fechita,horat1,tiposalidat1)'>"+salidat1+"</a>. Conductor: "+objeto["ConductorT"]+". Territorio: "+objeto["TerritorioT"]+"."};
							};
							if (vueltat===2) {
								salidat2=objeto["PuntoEncuentroT"];
								territoriot2=objeto["TerritorioT"];
								tiposalidat2=objeto["SalidaT"];
								horat2=objeto[clave];
								if (salidat2==="Zoom") {detallessalidast=detallessalidast+"<br>La salida por la tarde ser√° a las "+objeto[clave]+" "+objeto["SalidaT"]+" por "+salidat2+". Conductor: "+objeto["ConductorT"]+". Territorio: "+objeto["TerritorioT"]+"."}
								else {presencial="si";detallessalidast=detallessalidast+"<br>La salida por la tarde ser√° a las "+objeto[clave]+" "+objeto["SalidaT"]+" desde <a href='#' onclick='PuntoEncuentro(salidat2,territoriot2,fechita,horat2,tiposalidat2)'>"+salidat2+"</a>. Conductor: "+objeto["ConductorT"]+". Territorio: "+objeto["TerritorioT"]+"."};
							};
							if (vueltat===3) {
								salidat3=objeto["PuntoEncuentroT"];
								territoriot3=objeto["TerritorioT"];
								tiposalidat3=objeto["SalidaT"];
								horat3=objeto[clave];
								if (salidat3==="Zoom") {detallessalidast=detallessalidast+"<br>La salida por la tarde ser√° a las "+objeto[clave]+" "+objeto["SalidaT"]+" por "+salidat3+". Conductor: "+objeto["ConductorT"]+". Territorio: "+objeto["TerritorioT"]+"."}
								else {presencial="si";detallessalidast=detallessalidast+"<br>La salida por la tarde ser√° a las "+objeto[clave]+" "+objeto["SalidaT"]+" desde <a href='#' onclick='PuntoEncuentro(salidat3,territoriot3,fechita,horat3,tiposalidat3)'>"+salidat3+"</a>. Conductor: "+objeto["ConductorT"]+". Territorio: "+objeto["TerritorioT"]+"."};
							};
							if (vueltat===4) {
								salidat4=objeto["PuntoEncuentroT"];
								territoriot4=objeto["TerritorioT"];
								tiposalidat4=objeto["SalidaT"];
								horat4=objeto[clave];
								if (salidat4==="Zoom") {detallessalidast=detallessalidast+"<br>La salida por la tarde ser√° a las "+objeto[clave]+" "+objeto["SalidaT"]+" por "+salidat4+". Conductor: "+objeto["ConductorT"]+". Territorio: "+objeto["TerritorioT"]+"."}
								else {presencial="si";detallessalidast=detallessalidast+"<br>La salida por la tarde ser√° a las "+objeto[clave]+" "+objeto["SalidaT"]+" desde <a href='#' onclick='PuntoEncuentro(salidat4,territoriot4,fechita,horat4,tiposalidat4)'>"+salidat4+"</a>. Conductor: "+objeto["ConductorT"]+". Territorio: "+objeto["TerritorioT"]+"."};
							};
							if (vueltat===5) {
								salidat5=objeto["PuntoEncuentroT"];
								territoriot5=objeto["TerritorioT"];
								tiposalidat5=objeto["SalidaT"];
								horat5=objeto[clave];
								if (salidat5==="Zoom") {detallessalidast=detallessalidast+"<br>La salida por la tarde ser√° a las "+objeto[clave]+" "+objeto["SalidaT"]+" por "+salidat5+". Conductor: "+objeto["ConductorT"]+". Territorio: "+objeto["TerritorioT"]+"."}
								else {presencial="si";detallessalidast=detallessalidast+"<br>La salida por la tarde ser√° a las "+objeto[clave]+" "+objeto["SalidaT"]+" desde <a href='#' onclick='PuntoEncuentro(salidat5,territoriot5,fechita,horat5,tiposalidat5)'>"+salidat5+"</a>. Conductor: "+objeto["ConductorT"]+". Territorio: "+objeto["TerritorioT"]+"."};
							};
						};
						if (clave==="HoraN" && objeto[clave] !=="") {
							vueltan=vueltan+1;
							if (vueltan===1) {
								salidan1=objeto["PuntoEncuentroN"];
								territorion1=objeto["TerritorioN"];
								tiposalidan1=objeto["SalidaN"];
								horan1=objeto[clave];
								if (salidan1==="Zoom") {detallessalidasn=detallessalidasn+"La salida por la noche ser√° a las "+objeto[clave]+" "+objeto["SalidaN"]+" por "+salidan1+". Conductor: "+objeto["ConductorN"]+". Territorio: "+objeto["TerritorioN"]+"."}
								else {presencial="si";detallessalidasn=detallessalidasn+"La salida por la noche ser√° a las "+objeto[clave]+" "+objeto["SalidaN"]+" desde <a href='#' onclick='PuntoEncuentro(salidan1,territorion1,fechita,horan1,tiposalidan1)'>"+salidan1+"</a>. Conductor: "+objeto["ConductorN"]+". Territorio: "+objeto["TerritorioN"]+"."};
							};
							if (vueltan===2) {
								salidan2=objeto["PuntoEncuentroN"];
								territorion2=objeto["TerritorioN"];
								tiposalidan2=objeto["SalidaN"];
								horan2=objeto[clave];
								if (salidan2==="Zoom") {detallessalidasn=detallessalidasn+"<br>La salida por la noche ser√° a las "+objeto[clave]+" "+objeto["SalidaN"]+" por "+salidan2+". Conductor: "+objeto["ConductorN"]+". Territorio: "+objeto["TerritorioN"]+"."}
								else {presencial="si";detallessalidasn=detallessalidasn+"<br>La salida por la noche ser√° a las "+objeto[clave]+" "+objeto["SalidaN"]+" desde <a href='#' onclick='PuntoEncuentro(salidan2,territorion2,fechita,horan2,tiposalidan2)'>"+salidan2+"</a>. Conductor: "+objeto["ConductorN"]+". Territorio: "+objeto["TerritorioN"]+"."};
							};
							if (vueltan===3) {
								salidan3=objeto["PuntoEncuentroN"];
								territorion3=objeto["TerritorioN"];
								tiposalidan3=objeto["SalidaN"];
								horan3=objeto[clave];
								if (salidan3==="Zoom") {detallessalidasn=detallessalidasn+"<br>La salida por la noche ser√° a las "+objeto[clave]+" "+objeto["SalidaN"]+" por "+salidan3+". Conductor: "+objeto["ConductorN"]+". Territorio: "+objeto["TerritorioN"]+"."}
								else {presencial="si";detallessalidasn=detallessalidasn+"<br>La salida por la noche ser√° a las "+objeto[clave]+" "+objeto["SalidaN"]+" desde <a href='#' onclick='PuntoEncuentro(salidan3,territorion3,fechita,horan3,tiposalidan3)'>"+salidan3+"</a>. Conductor: "+objeto["ConductorN"]+". Territorio: "+objeto["TerritorioN"]+"."};
							};
							if (vueltan===4) {
								salidan4=objeto["PuntoEncuentroN"];
								territorion4=objeto["TerritorioN"];
								tiposalidan4=objeto["SalidaN"];
								horan4=objeto[clave];
								if (salidan4==="Zoom") {detallessalidasn=detallessalidasn+"<br>La salida por la noche ser√° a las "+objeto[clave]+" "+objeto["SalidaN"]+" por "+salidan4+". Conductor: "+objeto["ConductorN"]+". Territorio: "+objeto["TerritorioN"]+"."}
								else {presencial="si";detallessalidasn=detallessalidasn+"<br>La salida por la noche ser√° a las "+objeto[clave]+" "+objeto["SalidaN"]+" desde <a href='#' onclick='PuntoEncuentro(salidan4,territorion4,fechita,horan4,tiposalidan4)'>"+salidan4+"</a>. Conductor: "+objeto["ConductorN"]+". Territorio: "+objeto["TerritorioN"]+"."};
							};
							if (vueltan===5) {
								salidan5=objeto["PuntoEncuentroN"];
								territorion5=objeto["TerritorioN"];
								tiposalidan5=objeto["SalidaN"];
								horan5=objeto[clave];
								if (salidan5==="Zoom") {detallessalidasn=detallessalidasn+"<br>La salida por la noche ser√° a las "+objeto[clave]+" "+objeto["SalidaN"]+" por "+salidan5+". Conductor: "+objeto["ConductorN"]+". Territorio: "+objeto["TerritorioN"]+"."}
								else {presencial="si";detallessalidasn=detallessalidasn+"<br>La salida por la noche ser√° a las "+objeto[clave]+" "+objeto["SalidaN"]+" desde <a href='#' onclick='PuntoEncuentro(salidan5,territorion5,fechita,horan5,tiposalidan5)'>"+salidan5+"</a>. Conductor: "+objeto["ConductorN"]+". Territorio: "+objeto["TerritorioN"]+"."};
							};
						};
					};
				});
			};
			
			if (detallessalidasm) {detallessalidas=detallessalidasm};
			if (detallessalidast && detallessalidas) {detallessalidas=detallessalidas+"<br>"+detallessalidast};
			if (detallessalidast && !detallessalidas) {detallessalidas=detallessalidast};
			if (detallessalidasn && detallessalidas) {detallessalidas=detallessalidas+"<br>"+detallessalidasn};
			if (detallessalidasn && !detallessalidas) {detallessalidas=detallessalidasn};
			if (detallessalidas && presencial==="si") {detallessalidas=detallessalidas+"<br><br>En el caso de las salidas de casa en casa, toca el lugar de encuentro (lo veras resaltado en color) para verlo en el mapa junto con el territorio a predicar.-"};
			if (!detallessalidas) {detallessalidas="Ese d√≠a no hay salidas programadas.-"};
			document.getElementById("DetallesSalidas").innerHTML=detallessalidas;
			document.getElementById("titulo-modalsal").innerText=fecha;
		};
		
		function PuntoEncuentro(puntosalida,territorioapredicar,fecha,hora,tiposalida) {
			CerrarModalCalendario('modal1');
			CerrarModalCalendario('modal2');
			if (capa_territoriofiltrado) mapa.removeLayer(capa_territoriofiltrado);
			let resultado = puntosencuentro.find(p => p.Lugar === puntosalida);
			coordsalida=resultado.Coordenadas.split(",");
			var coord=[];
			coord.push(coordsalida[0],coordsalida[1]);
			if (marcapuntosalida) {marcapuntosalida.remove()};
			marcapuntosalida=L.marker(coord,{icon:L.icon({iconUrl: 'images/predicando.jpg',iconSize: [50, 55],iconAnchor: [16, 37],popupAnchor: [0, -28]}),title:""+fecha+" a las "+hora+" "+tiposalida+": "+puntosalida+". Territorio: "+territorioapredicar})
					.bindPopup(""+fecha+" a las "+hora+" "+tiposalida+": "+puntosalida+". Territorio: "+territorioapredicar)
					.openPopup().addTo(mapa);
			mapa.flyTo(coord,16);
			puntomascercano=[];
			let coordlat= Number(coordsalida[0]);
			let coordlon= Number(coordsalida[1]);
			puntomascercano.push(coordlat,coordlon);
			if (typeof territorioapredicar === "number" && !isNaN(territorioapredicar)) {
				TerritorioAbuscar(territorioapredicar,"salida");
			} else {
				if (territorioapredicar.includes("y") || territorioapredicar.includes(",") || territorioapredicar.includes(";") || territorioapredicar.includes("-") || territorioapredicar.includes(" ")) {
					if (capa_coloresterritorios) {mapa.removeLayer(capa_coloresterritorios)};
					if (capa_numerosterritorios) {mapa.removeLayer(capa_numerosterritorios)};
					if (capa_infoterritorios) {mapa.removeLayer(capa_infoterritorios)};
					if (nada) {mapa.removeLayer(nada)};
					if (capa_territoriofiltrado) {mapa.removeLayer(capa_territoriofiltrado)};
					if (capa_territoriofiltradonumero) {mapa.removeLayer(capa_territoriofiltradonumero)};
					if (numeroterritorio) {mapa.removeLayer(numeroterritorio)};
					if (marcapuntosalida && ! cartografiar==="salida") {marcapuntosalida.remove()};
					if (capa_casas) {mapa.removeLayer(capa_casas)};
					if (casa) {casa.remove()};
					if (casitas) {casitas.remove()};
					if (ruta) {ruta.remove()};
					cartografiar="salida";
					FiltrarVariosTerritorios(territorioapredicar);
					if (capa_infoterritorios) {capa_infoterritorios.addTo(mapa)};
					//capa_territoriofiltradonumero=L.geoJSON(territorios,{filter:FiltrarVariosTerritoriosNumero, onEachFeature: NumeroTerritorio}).addTo(mapa);
					if (seguimiento==="si") {
						alert("Ac√°...!!!");
						titulomodalflash.innerText="TRAZAR RUTA";
						cuerpomodalflash.innerHTML = '<span style="color:green"><br><b>¬øNecesit√°s ayuda para llegar?.</b><br><br><span style="color:black">Puedo trazarte una ruta '+
						'a partir de tu ubicaci√≥n actual y brindarte algunas indicaciones.-<br></span>';
						btnindicacionesmodalflash.style.display='flex';
						tiempomodalflash=5000;
						ModalFlash(tiempomodalflash);
					};
				};
			};
		};
		
		function FiltrarVariosTerritorios(num_terr) {
			const idSet = AnalizarCadenaVariosTerritorios(num_terr);
			capa_territoriofiltrado = L.geoJSON(territorios, {
				filter: f => ConjuntoCoincidencias(f, idSet),
				style: f => ConjuntoCoincidencias(f, idSet) ? highlightStyle : defaultStyle,
				onEachFeature: (f, layer) => {
					layer.bindPopup(`Numero: ${f.properties.Numero}<br>`);
				}
			}).addTo(mapa);
			if (capa_territoriofiltradonumero) {mapa.removeLayer(capa_territoriofiltradonumero)};
			capa_territoriofiltradonumero = L.geoJSON(territorios, {
				filter: f => ConjuntoCoincidencias(f, idSet),
				onEachFeature: NumeroTerritorio
			}).addTo(mapa);
		};
		
		// --- Parser que soporta rangos ---
		function AnalizarCadenaVariosTerritorios(str) {
			const result = new Set();
			if (!str) return result;
			str.split(',').forEach(part => {
				const token = part.trim();
				if (!token) return;
				// Si es rango "x-y"
				if (/^\d+\s*-\s*\d+$/.test(token)) {
				let [start, end] = token.split('-').map(s => Number(s.trim()));
				if (!isNaN(start) && !isNaN(end)) {
					if (start > end) [start, end] = [end, start]; // soporta "7-3"
					for (let i = start; i <= end; i++) result.add(i);
				}
				} else {
					// N√∫mero suelto
					const n = Number(token);
					if (!isNaN(n)) result.add(n);
				}
			});
			return result;
		};
		const defaultStyle = {fillColor: "#020259",	weight: 4, opacity: 1, color: "#46fafa", dashArray: '3', fillOpacity: 0.3};
		const highlightStyle = {color: '#020259', weight: 2, fillOpacity: 0.35};
		function ConjuntoCoincidencias(feature, idSet, propName = 'Numero') {
			if (!feature || !feature.properties) return false;
			return idSet.has(feature.properties[propName]);
		};
		
		<!--Funci√≥n para enviar reporte de lo que se abarc√≥ en cada salida-->
		function ReportarPredicado() {
			barralateral.close();
			document.getElementById("ModalReportePredicado").style.visibility='visible';
			document.getElementById("btn-cerrar-reporte").style.visibility='visible';
			document.getElementById("btn-enviar-reporte").style.visibility='visible';
		};
		
		<!--Funci√≥n para cerrar el modal del reporte de lo predicado-->
		function CerrarModalReporte () {
			document.getElementById("leyendamanzanaspredicadas").style.display = "block";
			document.getElementById("todopredicado").checked = false; document.getElementById("algopredicado").checked = false;
			document.getElementById('nombrepredicado').value="";document.getElementById('fechapredicado').value="";
			document.getElementById('territoriopredicado').value="";document.getElementById('abarcadopredicado').value="";
			document.getElementById("enviandoreporte").textContent ="";
			document.getElementById("ModalReportePredicado").style.visibility='hidden';
			document.getElementById("manzanaspredicadas").style.visibility='hidden';
			document.getElementById("leyendamanzanaspredicadas").style.visibility='hidden';
			document.getElementById("btn-cerrar-reporte").style.visibility="hidden";
			document.getElementById("btn-enviar-reporte").style.visibility="hidden";
			//document.getElementById("btn-cerrar-reportenovisitar").style.visibility='hidden';
			//document.getElementById("btn-enviar-reportenovisitar").style.visibility='hidden';
			clearTimeout(temporizadorpredicado);
		};
		
		<!--Funci√≥n para revisar y enviar el reporte de lo predicado-->
		document.getElementById('btn-enviar-reporte').addEventListener('click', async () => {
			document.getElementById("btn-cerrar-reporte").style.visibility="visible";
			document.getElementById("btn-enviar-reporte").style.visibility="visible";
			const enviando = document.getElementById('enviandoreporte');
			document.getElementById("leyendamanzanaspredicadas").style.display = "none";
			if (document.getElementById('nombrepredicado').value==="" || document.getElementById('territoriopredicado').value==="" || document.getElementById('fechapredicado').value===""
			|| (!todopred.checked && !partepred.checked) || (partepred.checked && document.getElementById('abarcadopredicado').value==="")) {
				if (document.getElementById('fechapredicado').value==="") {document.getElementById("fechapredicado").placeholder = "Por favor, ingres√° alguna fecha aqu√≠...";document.getElementById("fechapredicado").focus()};
				if (document.getElementById('nombrepredicado').value==="") {document.getElementById("nombrepredicado").placeholder = "Por favor, ingres√° tu nombre aqu√≠...";document.getElementById("nombrepredicado").focus()};
				if (document.getElementById('territoriopredicado').value==="") {document.getElementById("territoriopredicado").placeholder = "Por favor, ingres√° el n√∫mero del territorio aqu√≠...";document.getElementById("territoriopredicado").focus()};
				if (document.getElementById('abarcadopredicado').value==="") {document.getElementById("leyendamanzanaspredicadas").style.display = "block";document.getElementById("abarcadopredicado").placeholder = "Por favor, ingres√° alg√∫n dato aqu√≠...";document.getElementById("abarcadopredicado").focus()};
				enviando.style.color = "red";
				enviando.textContent = 'Por favor, revis√° que falta alg√∫n dato...';
			} else {
				enviando.style.color = "black";
				enviando.textContent = 'Enviando...Por favor, esper√° un momento.-';
				document.getElementById("btn-cerrar-reporte").style.visibility="hidden";
				document.getElementById("btn-enviar-reporte").style.visibility="hidden";
				const fd = new FormData();
				fd.append('fecha', document.getElementById('fechapredicado').value);
				fd.append('nombre', document.getElementById('nombrepredicado').value);
				fd.append('territorio', document.getElementById('territoriopredicado').value);
				if (todopred.checked) {fd.append('abarcado', "Completo")};
				if (partepred.checked) {fd.append('abarcado', document.getElementById('abarcadopredicado').value)};
				try {
					const res = await fetch(url_script_territorios, { method: 'POST', body: fd });
					const text = await res.text();
					enviando.textContent = 'HTTP ' + res.status + '\\n' + text;
					try {enviando.style.color = "green";enviando.textContent ="Informaci√≥n enviada. Muchas gracias....!!!";
						document.getElementById("btn-cerrar-reporte").style.visibility="visible";
						temporizadorpredicado=setTimeout(() => {
							document.getElementById("leyendamanzanaspredicadas").style.display = "block";
							document.getElementById("todopredicado").checked = false; document.getElementById("algopredicado").checked = false;
							document.getElementById('nombrepredicado').value="";document.getElementById('fechapredicado').value="";
							document.getElementById('territoriopredicado').value="";document.getElementById('abarcadopredicado').value="";
							enviando.textContent ="";CerrarModalReporte()
							}
						, 5000)}
					catch(e){};
				} catch (err) {
					enviando.style.color = "red";
					enviando.textContent = 'Hubo un error; por lo que no se pudo enviar la informaci√≥n. Por favor, intentalo nuevamente.-';
					document.getElementById("btn-cerrar-reporte").style.visibility="visible";
					document.getElementById("btn-enviar-reporte").style.visibility="visible";
				};
			};
		});
		
		<!--Funci√≥n para revisar si se predic√≥ total o parcialmente el territorio en una salida-->
		var todopred=document.getElementById("todopredicado");
		var partepred=document.getElementById("algopredicado");
		todopred.addEventListener('change', () => {
			if (todopred.checked) {
				document.getElementById("manzanaspredicadas").style.visibility='hidden';
				document.getElementById("leyendamanzanaspredicadas").style.visibility='hidden';
				partepred.checked = false;
			};
		});
		partepred.addEventListener('change', () => {
			if (partepred.checked) {
				document.getElementById("manzanaspredicadas").style.visibility='visible';
				document.getElementById("leyendamanzanaspredicadas").style.visibility='visible';
				todopred.checked = false;
				document.getElementById("abarcadopredicado").focus();
			};
		});
		
		<!--Funci√≥n para enviar reporte de una nueva casa NO VISITAR-->
		function ReportarNoVisitar() {
			barralateral.close();
			document.getElementById("ModalReporteNoVisitar").style.visibility='visible';
			document.getElementById("btn-cerrar-reportenovisitar").style.visibility='visible';
			document.getElementById("btn-enviar-reportenovisitar").style.visibility='visible';
		};
		
		<!--Funci√≥n para cerrar el modal del reporte de NO VISITAR-->
		function CerrarModalNoVisitar () {
			document.getElementById("leyendadetallemotivonovisitar").style.display = "block"; document.getElementById("motivonovisitar").style.display = "block";
			document.getElementById("expresonovisitar").checked = false; document.getElementById("noexpresonovisitar").checked = false;
			document.getElementById('nombrenovisitar').value="";document.getElementById('fechanovisitar').value="";
			document.getElementById('territorionovisitar').value="";document.getElementById('detallemotivonovisitar').value="";document.getElementById('direccionnovisitar').value="";
			document.getElementById("enviandoreportenovisitar").textContent ="";
			document.getElementById("ModalReporteNoVisitar").style.visibility='hidden';
			document.getElementById("motivonovisitar").style.visibility='hidden';
			document.getElementById("detallemotivonovisitar").style.visibility='hidden';
			document.getElementById("leyendadetallemotivonovisitar").style.visibility='hidden';
			document.getElementById("btn-cerrar-reportenovisitar").style.visibility='hidden';
			document.getElementById("btn-enviar-reportenovisitar").style.visibility='hidden';
			//document.getElementById("btn-cerrar-reporte").style.visibility='hidden';
			//document.getElementById("btn-enviar-reporte").style.visibility='hidden';
			clearTimeout(temporizadornovisitar);
		};
		
		<!--Funci√≥n para revisar y enviar el reporte de NO VISITAR-->
		document.getElementById('btn-enviar-reportenovisitar').addEventListener('click', async () => {
			document.getElementById("btn-cerrar-reporte").style.visibility="visible";
			document.getElementById("btn-enviar-reporte").style.visibility="visible";
			const enviando = document.getElementById('enviandoreportenovisitar');
			//document.getElementById("leyendadetallemotivonovisitar").style.display = "none";
			//document.getElementById("motivonovisitar").style.display = "none";
			if (document.getElementById('nombrenovisitar').value==="" || document.getElementById('territorionovisitar').value==="" || document.getElementById('fechanovisitar').value==="" || document.getElementById('direccionnovisitar').value===""
			|| (!expresonovisitar.checked && !noexpresonovisitar.checked) || (noexpresonovisitar.checked && document.getElementById('detallemotivonovisitar').value==="")) {
				if (document.getElementById('fechanovisitar').value==="") {document.getElementById("fechanovisitar").placeholder = "Por favor, ingres√° alguna fecha aqu√≠...";document.getElementById("fechanovisitar").focus()};
				if (document.getElementById('nombrenovisitar').value==="") {document.getElementById("nombrenovisitar").placeholder = "Por favor, ingres√° tu nombre aqu√≠...";document.getElementById("nombrenovisitar").focus()};
				if (document.getElementById('direccionnovisitar').value==="") {document.getElementById("direccionnovisitar").placeholder = "Por favor, ingres√° la direcci√≥n de la casa aqu√≠...";document.getElementById("direccionnovisitar").focus()};
				if (document.getElementById('territorionovisitar').value==="") {document.getElementById("territorionovisitar").placeholder = "Por favor, ingres√° el n√∫mero del territorio aqu√≠...";document.getElementById("territorionovisitar").focus()};
				if (document.getElementById('detallemotivonovisitar').value==="") {document.getElementById("leyendadetallemotivonovisitar").style.display = "block"; document.getElementById("motivonovisitar").style.display = "block";document.getElementById("detallemotivonovisitar").placeholder = "Por favor, ingres√° alg√∫n dato aqu√≠...";document.getElementById("detallemotivonovisitar").focus()};
				enviando.style.color = "red";
				enviando.textContent = 'Por favor, revis√° que falta alg√∫n dato...';
			} else {
				enviando.style.color = "black";
				enviando.textContent = 'Enviando...Por favor, esper√° un momento.-';
				document.getElementById("btn-cerrar-reportenovisitar").style.visibility="hidden";
				document.getElementById("btn-enviar-reportenovisitar").style.visibility="hidden";
				document.getElementById("leyendadetallemotivonovisitar").style.visibility = "hidden";
				document.getElementById("motivonovisitar").style.display = "hidden";
				const fd = new FormData();
				fd.append('fecha', document.getElementById('fechanovisitar').value);
				fd.append('direccion', document.getElementById('direccionnovisitar').value);
				fd.append('territorio', document.getElementById('territorionovisitar').value);
				if (expresonovisitar.checked) {fd.append('detalle', "Me lo dijo expresamente.")};
				if (noexpresonovisitar.checked) {fd.append('detalle', document.getElementById('detallemotivonovisitar').value)};
				fd.append('nombre', document.getElementById('nombrenovisitar').value);
				try {
					const res = await fetch(url_script_novisitar, { method: 'POST', body: fd });
					const text = await res.text();
					enviando.textContent = 'HTTP ' + res.status + '\\n' + text;
					try {enviando.style.color = "green";enviando.textContent ="Informaci√≥n enviada. Muchas gracias....!!!";
						document.getElementById("btn-cerrar-reportenovisitar").style.visibility="visible";
						temporizadornovisitar=setTimeout(() => {
							document.getElementById("leyendadetallemotivonovisitar").style.display = "block"; document.getElementById("motivonovisitar").style.display = "block"; 
							document.getElementById("expresonovisitar").checked = false; document.getElementById("noexpresonovisitar").checked = false;
							document.getElementById('nombrenovisitar').value="";document.getElementById('fechanovisitar').value="";
							document.getElementById('territorionovisitar').value="";document.getElementById('detallemotivonovisitar').value="";document.getElementById('direccionnovisitar').value="";
							enviando.textContent ="";CerrarModalNoVisitar();
							}
						, 5000)}
					catch(e){};
				} catch (err) {
					enviando.style.color = "red";
					enviando.textContent = 'Hubo un error; por lo que no se pudo enviar la informaci√≥n. Por favor, intentalo nuevamente.-';
					document.getElementById("btn-cerrar-reportenovisitar").style.visibility="visible";
					document.getElementById("btn-enviar-reportenovisitar").style.visibility="visible";
				};
			};
		});
		
		<!--Funci√≥n para revisar si la persona dijo expresamente que NO LA VOLVIERAMOS A VISITAR-->
		var expresonovisitar=document.getElementById("expresonovisitar");
		var noexpresonovisitar=document.getElementById("noexpresonovisitar");
		expresonovisitar.addEventListener('change', () => {
			if (expresonovisitar.checked) {
				document.getElementById("motivonovisitar").style.visibility='hidden';
				document.getElementById("leyendadetallemotivonovisitar").style.visibility='hidden';
				document.getElementById("detallemotivonovisitar").style.visibility='hidden';
				noexpresonovisitar.checked = false;
			};
		});
		noexpresonovisitar.addEventListener('change', () => {
			if (noexpresonovisitar.checked) {
				document.getElementById("motivonovisitar").style.visibility='visible';
				document.getElementById("leyendadetallemotivonovisitar").style.visibility='visible';
				document.getElementById("detallemotivonovisitar").style.visibility='visible';
				expresonovisitar.checked = false;
				document.getElementById("detallemotivonovisitar").focus();
			};
		});
		
		// Funci√≥n que controla la vista de las manzanas seg√∫n el Zoom
		function ActualizarVistaManzanas() {
			const z = mapa.getZoom();
			if (z >= 17) { 
				// Mostrar detalles en zoom alto
				if (!mapa.hasLayer(grupomanzanas)) {
				mapa.addLayer(grupomanzanas);
				}
			} else {
				// Ocultar detalles si se aleja
				if (mapa.hasLayer(grupomanzanas)) {
					mapa.removeLayer(grupomanzanas);
				}
			}
		};
		// Ejecutar cada vez que cambie el zoom
		mapa.on("zoomend", ActualizarVistaManzanas);
		
		//Bloque para resaltar o remarcar lo nuevo
		//const elementonovedoso = document.getElementById('botonreportarpredicado');
		const elementonovedoso = document.getElementById('barralateral');
		const novedaden="barralateral";//Cambiar si fuera otro elemento el que contenga la novedad
		// Fechas de inicio y fin para resaltar o remarcar una novedad (pueden incluir hora si quer√©s)
		const inicio = new Date("2026-01-10"); //yyyy-mm-dd
		const fin = new Date("2026-02-10"); //yyyy-mm-dd
		const hoy = new Date();
		const cartelnuevo = document.getElementById('cartelnuevo');
		if (hoy >= inicio && hoy <= fin && Version !==localStorage.getItem('MOSTRAR_NUEVO')) {
			elementonovedoso.classList.add('resaltarlonovedoso');
			abrirnovedad();
			const tiempo = setTimeout(() => {
				elementonovedoso.classList.remove('resaltarlonovedoso');
				cerrarnovedad();
			}, 25000);
		} else {
			cerrarnovedad()
		};
		
		//Bloque para LO NUEVO
		function abrirnovedad(){
			cartelnuevo.style.display = 'block';
			// posicionar la gu√≠a apuntando al bot√≥n
			if (dispositivo !=="movil") {document.getElementById("flecharoja").style.visibility='visible'};
			posicionnovedad();
			// animaci√≥n de aparici√≥n
			requestAnimationFrame(()=> cartelnuevo.classList.add('show'));
		};

		function cerrarnovedad(){
			cartelnuevo.classList.remove('show');
			// despu√©s de la transici√≥n, ocultamos
			setTimeout(()=> cartelnuevo.style.display = 'none', 160);
			document.getElementById("flecharoja").style.visibility='hidden';
			if (nomostrarlonuevo.checked) {
				try {
					localStorage.setItem('MOSTRAR_NUEVO', Version);
				} catch(e){
					// ignore storage errors
					console.warn('No se pudo guardar preferencia en localStorage', e);
				}
			}
		};

		function posicionnovedad(){
			if (novedaden !=="barralateral") {
				const btnRect = elementonovedoso.getBoundingClientRect();
				const gRect = cartelnuevo.getBoundingClientRect();
				const margin = 10; // separaci√≥n m√≠nima

				// ancho disponible y c√°lculo base
				const viewportW = document.documentElement.clientWidth;
				const viewportH = document.documentElement.clientHeight;

				// calculamos left centrado respecto al bot√≥n
				let left = btnRect.left + (btnRect.width/2) - (gRect.width/2);
				//let top=btnRect.height/2;//Para el caso de tratarse de la barra lateral
				// recortamos para que no se salga de la pantalla
				left = Math.max(8, Math.min(left, viewportW - gRect.width - 8));

				// por defecto situamos arriba del bot√≥n
				let top = btnRect.top - gRect.height - margin;
				//let left=75;//Para el caso de tratarse de la barra lateral
				cartelnuevo.classList.remove('bottom');

				// si no cabe arriba, lo ponemos abajo
				if(top < 8){
				top = btnRect.bottom + margin;
				cartelnuevo.classList.add('bottom');
				}

				cartelnuevo.style.left = left + 'px';
				cartelnuevo.style.top = top + 'px';

				// posicionamos la flecha horizontalmente para que apunte al centro del bot√≥n
				// calculamos la diferencia entre el centro del modal y el centro del bot√≥n
				const modalCenterX = left + gRect.width/2;
				const btnCenterX = btnRect.left + btnRect.width/2;
				// queremos que --arrow-x sea la mitad de la flecha (negativa) + offset para centrar
				const arrowOffset = btnCenterX - modalCenterX;
				// la pseudo-element tiene left:50% y margin-left: calc(var(--arrow-x, -7px))
				// as√≠ que ponemos --arrow-x en px
				cartelnuevo.style.setProperty('--arrow-x', (arrowOffset - 7) + 'px');
			} else {
				cartelnuevo.style.left = '7%';
				cartelnuevo.style.top = '50%';
				document.querySelector('.novedad').classList.add('oculto');
			};
		};

		// reposicionar si hay resize o scroll
		window.addEventListener('resize', ()=>{
			if(cartelnuevo.style.display !== 'none') posicionnovedad();
		});
		window.addEventListener('scroll', ()=>{
			if(cartelnuevo.style.display !== 'none') posicionnovedad();
		}, {passive:true});

		// tambien cerrar con escape
		document.addEventListener('keydown', (e)=>{
			if(e.key === 'Escape') cerrarnovedad();
		});

		//Funci√≥n para volver a mostrar los modales o mensajes cancelados por el usuario
		function RestablecerNoMostrar() {
			let inicial = Version;
			let numer = Number(inicial);
			let numero=numer-1;
			localStorage.setItem('MOSTRAR_INICIAL', numero);
			localStorage.setItem('MOSTRAR_NUEVO', numero);
			localStorage.setItem('MOSTRAR_CELULAR', "si");
			barralateral.close();
			document.getElementById("restablecernomostrar").style.visibility="hidden";
		};
		
		//Funci√≥n No Volver a mostrar sugerencia para girar el celular
		function VerificarNoVolverAMostrar(){
			if (Version !== (localStorage.getItem('MOSTRAR_INICIAL')|| null)) {ModalFlash(tiempomodalflash);document.getElementById("restablecernomostrar").style.visibility="hidden"} else {document.getElementById("borrableinicial").style.display="none";document.getElementById("borrablelonuevo").display="none";document.getElementById("restablecernomostrar").style.visibility="visible"};
			if (localStorage.getItem('MOSTRAR_CELULAR') !=="no" && dispositivo !=="pc") {modalinicial.showModal();document.getElementById("restablecernomostrar").style.visibility="hidden"} else {document.getElementById("borrablecelular").display="none";document.getElementById("restablecernomostrar").style.visibility="visible"};
			if (Version !== (localStorage.getItem('MOSTRAR_NUEVO') || null)) {document.getElementById("flecharoja").style.visibility='visible';abrirnovedad()} else {document.getElementById("flecharoja").style.visibility='hidden'};
			if (dispositivo=="movil") {document.getElementById("flecharoja").style.visibility='hidden'};
		};
		
		//Activar/Desactivar/Mostrar/Ocultar/Ejecutar lo que corresponda al iniciar
		document.getElementById("vermiubicacion").style.visibility='hidden';
		document.getElementById("flecharoja").style.visibility='hidden';
		document.getElementById("miubicacion").style.visibility='hidden';
		document.getElementById("botoncentrado").style.visibility='hidden';
		document.getElementById("botonnorte").style.visibility='hidden';
		document.getElementById("ModalReportePredicado").style.visibility='hidden';
		document.getElementById("manzanaspredicadas").style.visibility='hidden';
		document.getElementById("leyendamanzanaspredicadas").style.visibility='hidden';
		document.getElementById("ModalReporteNoVisitar").style.visibility='hidden';
		document.getElementById("motivonovisitar").style.visibility='hidden';
		document.getElementById("detallemotivonovisitar").style.visibility='hidden';
		document.getElementById("leyendadetallemotivonovisitar").style.visibility='hidden';
		document.getElementById("botoncentrado").style.visibility='hidden';
		cajadistancia.classList.remove('visible');
		mimodalflash.style.display='none';
		botondetallesruta.style.display='none';
		VerificarConexion();
		VerificarVersion();
		VerificarNoVolverAMostrar();
		//if (dispositivo==="movil") {mapa.style.height = "80%"};
		if (dispositivo==="") {dispositivo="desconocido"};
		window.addEventListener("load", async () => {
			const fd = new FormData();
			fd.append('dispositivo', dispositivo);
			fd.append('mapavisitado', 'SVN');
			try {
				const res = await fetch(drivecontadorvisitas, {
					method: 'POST',
					body: fd
				});
				const text = await res.text();
				try {
					//enviando.textContent = "Informaci√≥n enviada. Muchas gracias....!!!" 
					//+ '\n' + res.status 
					//+ '\n' + text 
					//+ '\n' + data;
					//alert("Enviado correctamente.-");
				} catch(e) {}
			} catch (err) {
				//enviando.textContent = 'Hubo un error; por lo que no se pudo enviar la informaci√≥n. Por favor, intentalo nuevamente.-';
			}
		});
	</script>
</html>